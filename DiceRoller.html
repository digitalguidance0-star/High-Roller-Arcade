<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DICE DETOX‚Ñ¢ V2 ‚Äî Luxury Arcade Engine</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:ital,wght@0,400;0,500;1,400&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
/* =====================================================
   DICE DETOX V2 ‚Äî LUXURY ARCADE ENGINE
   Real dice logic. Cee-Lo Bot Table. Three Premium Expansions.
   ===================================================== */
:root {
  --bg:#080709;--bg2:#0d0b0f;
  --surface:rgba(255,255,255,0.035);--surface2:rgba(255,255,255,0.06);--surface3:rgba(255,255,255,0.09);
  --border:rgba(255,255,255,0.07);--border2:rgba(255,255,255,0.12);
  --text:#ede8e0;--text2:#7a7068;--text3:#3d3830;
  --gold:#c8a84b;--gold2:#e8c870;--gold-dim:rgba(200,168,75,0.15);
  --green:#4a8c62;--red:#8c4040;--red2:#c05050;--blue:#4a6a9c;
  --sat:1;--bri:1;
  /* Cinematic tension vars ‚Äî injected by JS */
  --tension:0;
  --table-red:0;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);}
body{font-family:'Syne',sans-serif;color:var(--text);filter:saturate(var(--sat)) brightness(var(--bri));transition:filter 4s ease;}
.screen{position:fixed;inset:0;display:none;flex-direction:column;}
.screen.active{display:flex;}
::-webkit-scrollbar{width:3px;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

/* =====================================================  HOME  ===================================================== */
#scr-home{background:radial-gradient(ellipse 80% 60% at 50% -10%,#1a140a 0%,var(--bg) 55%);align-items:center;justify-content:center;}
#scr-home::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 47px,rgba(255,255,255,0.012) 48px),repeating-linear-gradient(90deg,transparent,transparent 47px,rgba(255,255,255,0.012) 48px);pointer-events:none;}
.home-wrap{position:relative;text-align:center;width:100%;max-width:680px;padding:0 32px;}
.logo-wrap{margin-bottom:40px;}
.logo-main{font-family:'Bebas Neue',sans-serif;font-size:clamp(64px,10vw,96px);letter-spacing:10px;line-height:1;color:var(--text);text-shadow:0 0 80px rgba(200,168,75,0.12);}
.logo-main em{color:var(--gold);font-style:normal;}
.logo-ver{display:inline-block;background:var(--gold-dim);border:1px solid rgba(200,168,75,0.25);border-radius:6px;padding:3px 10px;font-size:10px;letter-spacing:4px;color:var(--gold);margin-top:8px;font-family:'DM Mono',monospace;}
.logo-sub{font-size:11px;letter-spacing:5px;text-transform:uppercase;color:var(--text2);margin-top:12px;font-weight:400;}
.home-divider{width:180px;height:1px;background:linear-gradient(90deg,transparent,rgba(200,168,75,0.3),transparent);margin:32px auto;}
.mode-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:32px;}
.mode-card{padding:18px 12px;border:1px solid var(--border);border-radius:18px;background:var(--surface);cursor:pointer;transition:all 0.22s cubic-bezier(0.4,0,0.2,1);position:relative;overflow:hidden;}
.mode-card::after{content:'';position:absolute;inset:0;border-radius:18px;background:linear-gradient(135deg,rgba(200,168,75,0.08),transparent);opacity:0;transition:opacity 0.22s;}
.mode-card:hover{transform:translateY(-3px);border-color:rgba(200,168,75,0.25);box-shadow:0 12px 40px rgba(0,0,0,0.5);}
.mode-card:hover::after,.mode-card.selected::after{opacity:1;}
.mode-card.selected{border-color:rgba(200,168,75,0.5);background:rgba(200,168,75,0.08);}
.mode-icon{font-size:26px;margin-bottom:8px;}
.mode-name{font-size:12px;font-weight:700;letter-spacing:1px;color:var(--text);}
.mode-desc{font-size:9px;color:var(--text2);margin-top:4px;letter-spacing:0.3px;}
.mode-badge{display:inline-block;font-size:7px;letter-spacing:2px;text-transform:uppercase;background:rgba(200,168,75,0.12);border:1px solid rgba(200,168,75,0.25);border-radius:4px;padding:1px 5px;color:var(--gold);margin-top:4px;}
.enter-btn{width:100%;height:60px;border-radius:18px;background:linear-gradient(135deg,rgba(200,168,75,0.15),rgba(200,168,75,0.08));border:1px solid rgba(200,168,75,0.35);color:var(--gold2);font-family:'Syne',sans-serif;font-size:13px;font-weight:700;letter-spacing:4px;text-transform:uppercase;cursor:pointer;transition:all 0.2s;}
.enter-btn:hover{background:linear-gradient(135deg,rgba(200,168,75,0.22),rgba(200,168,75,0.12));box-shadow:0 8px 32px rgba(200,168,75,0.12);}
.home-nav{position:absolute;bottom:0;left:0;right:0;height:52px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:center;gap:40px;background:rgba(8,7,9,0.85);backdrop-filter:blur(12px);}
.home-nav-btn{font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--text2);cursor:pointer;padding:8px 0;transition:color 0.18s;font-family:'Syne',sans-serif;font-weight:600;background:none;border:none;}
.home-nav-btn:hover{color:var(--text);}
.xp-home{margin-top:24px;text-align:left;}
.xp-home-label{display:flex;justify-content:space-between;font-size:10px;letter-spacing:2px;color:var(--text3);text-transform:uppercase;margin-bottom:6px;}
.xp-home-track{height:3px;background:var(--surface2);border-radius:2px;overflow:hidden;}
.xp-home-fill{height:100%;background:linear-gradient(90deg,var(--gold),var(--gold2));border-radius:2px;transition:width 0.6s ease;}

/* =====================================================  GAME SCREEN  ===================================================== */
#scr-game{overflow:hidden;}
#alley-bg{position:absolute;inset:0;z-index:0;}

/* TOP HUD */
.top-hud{position:relative;z-index:20;height:64px;background:rgba(8,7,9,0.92);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);display:grid;grid-template-columns:300px 1fr 340px;align-items:center;padding:0 20px;flex-shrink:0;}
.hud-left{display:flex;align-items:center;gap:16px;}
.hud-mode-badge{padding:5px 14px;border-radius:8px;background:var(--surface2);border:1px solid var(--border);font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--gold);font-family:'DM Mono',monospace;}
.hud-level{display:flex;flex-direction:column;gap:2px;}
.hud-level-num{font-size:11px;color:var(--text2);font-family:'DM Mono',monospace;}
.hud-xp-bar{width:80px;height:2px;background:rgba(255,255,255,0.06);border-radius:1px;overflow:hidden;}
.hud-xp-fill{height:100%;background:var(--gold);border-radius:1px;transition:width 0.5s ease;}
.hud-center{display:flex;flex-direction:column;align-items:center;}
.hud-timer-row{display:flex;align-items:center;gap:10px;}
.timer-ring-wrap{position:relative;width:40px;height:40px;}
.timer-ring-wrap svg{transform:rotate(-90deg);}
.timer-ring-track{fill:none;stroke:rgba(255,255,255,0.05);stroke-width:2;}
.timer-ring-fill{fill:none;stroke:var(--gold);stroke-width:2;stroke-linecap:round;stroke-dasharray:113;stroke-dashoffset:113;transition:stroke-dashoffset 1s linear;}
.timer-ring-text{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:'DM Mono',monospace;font-size:10px;color:var(--text2);}
.hud-objective{font-size:10px;color:var(--text3);letter-spacing:1px;text-align:center;}
.hud-objective span{color:var(--gold);}
.hud-right{display:flex;align-items:center;justify-content:flex-end;gap:20px;}
.hud-stat-block{text-align:right;}
.hud-stat-val{font-family:'DM Mono',monospace;font-size:18px;color:var(--text);line-height:1;}
.hud-stat-label{font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--text3);}
.stim-col{display:flex;flex-direction:column;gap:3px;align-items:flex-end;}
.stim-track{width:72px;height:2px;background:rgba(255,255,255,0.05);border-radius:1px;overflow:hidden;}
.stim-fill{height:100%;border-radius:1px;transition:width 3s ease;background:linear-gradient(90deg,#4a8c62,var(--gold));}

/* GAME BODY */
.game-body{position:relative;z-index:5;flex:1;min-height:0;display:grid;grid-template-columns:260px 1fr 340px;}

/* LEFT: BOT PANEL ‚Äî now with scoreboard */
.bot-panel{display:flex;flex-direction:column;border-right:1px solid var(--border);background:rgba(8,7,9,0.75);backdrop-filter:blur(12px);overflow:hidden;}
.bot-panel-hdr{padding:10px 16px 8px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);}
.bot-panel-hdr-title{font-size:8px;letter-spacing:3px;text-transform:uppercase;color:var(--text3);}
.bot-panel-mode{font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--gold);font-family:'DM Mono',monospace;}
.bot-list{flex:1;padding:8px;display:flex;flex-direction:column;gap:6px;overflow-y:auto;}

/* BOT CARD */
.bot-card{padding:12px 14px;border-radius:14px;border:1px solid var(--border);background:var(--surface);transition:all 0.3s cubic-bezier(0.4,0,0.2,1);position:relative;overflow:hidden;cursor:default;}
.bot-card.active-roller{border-color:rgba(200,168,75,0.4);background:rgba(200,168,75,0.06);box-shadow:0 0 24px rgba(200,168,75,0.06);}
.bot-card.inactive{opacity:0.45;}
.bot-card.rerolling-bot{border-color:rgba(200,100,20,0.5);background:rgba(140,60,10,0.08);animation:rerollPulse 1.1s ease-in-out infinite;}
.bot-card-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.bot-name{font-size:11px;font-weight:700;}
.bot-mood{width:7px;height:7px;border-radius:50%;transition:background 0.5s;}
.mood-hot{background:#c8962a;}.mood-neutral{background:#5a5550;}.mood-cool{background:#3a7a5a;}.mood-tilt{background:#8c3a3a;}
.bot-meters{display:flex;flex-direction:column;gap:4px;margin-bottom:8px;}
.meter-row{display:flex;align-items:center;gap:6px;}
.meter-lbl{font-size:8px;letter-spacing:1px;text-transform:uppercase;color:var(--text3);width:48px;}
.meter-track{flex:1;height:2px;background:rgba(255,255,255,0.05);border-radius:1px;overflow:hidden;}
.conf-bar{height:100%;border-radius:1px;background:linear-gradient(90deg,#3a5a8c,#6a90d4);transition:width 0.5s ease;}
.tilt-bar{height:100%;border-radius:1px;background:linear-gradient(90deg,#6a3030,#c04040);transition:width 0.5s ease;}
.bot-footer{display:flex;justify-content:space-between;align-items:flex-end;}
.bot-bank{font-family:'DM Mono',monospace;font-size:12px;color:var(--text);}
.bot-say{font-size:9px;color:var(--text2);font-style:italic;text-align:right;max-width:100px;line-height:1.3;transition:opacity 0.3s;}

/* Bot last-roll result bubble (Cee-Lo Bot Table) */
.bot-result-bubble{
  position:absolute;top:10px;right:12px;
  min-width:44px;padding:3px 8px;border-radius:8px;
  font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:1px;
  text-align:center;transition:all 0.4s;opacity:0;
}
.bot-result-bubble.show{opacity:1;}
.brb-win{background:rgba(74,140,98,0.2);border:1px solid rgba(74,140,98,0.4);color:#6ab88a;}
.brb-loss{background:rgba(140,64,64,0.2);border:1px solid rgba(140,64,64,0.4);color:#c07070;}
.brb-point{background:rgba(200,168,75,0.15);border:1px solid rgba(200,168,75,0.3);color:var(--gold);}
.brb-reroll{background:rgba(120,70,10,0.2);border:1px solid rgba(160,90,20,0.35);color:#c07830;}
.brb-reroll-anim{animation:rerollBubblePulse 0.7s ease;}

/* EXPANSION 1: LIVE SCOREBOARD (bottom of bot panel) */
.scoreboard{
  flex-shrink:0;border-top:1px solid var(--border);padding:8px;
  background:rgba(5,4,6,0.6);
}
.scoreboard-hdr{font-size:7px;letter-spacing:3px;text-transform:uppercase;color:var(--text3);margin-bottom:6px;padding:0 2px;}
.scoreboard-row{display:flex;align-items:center;gap:6px;padding:3px 4px;border-radius:6px;transition:background 0.2s;}
.scoreboard-row.sb-leader{background:rgba(200,168,75,0.07);border:1px solid rgba(200,168,75,0.12);}
.sb-rank{font-family:'Bebas Neue',sans-serif;font-size:12px;color:var(--text3);width:12px;text-align:center;}
.sb-rank.gold{color:var(--gold);}
.sb-name{font-size:9px;color:var(--text2);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.sb-wins{font-family:'DM Mono',monospace;font-size:9px;color:var(--green);}
.sb-losses{font-family:'DM Mono',monospace;font-size:9px;color:var(--red2);}
.sb-bank{font-family:'DM Mono',monospace;font-size:9px;color:var(--text);min-width:44px;text-align:right;}

/* CENTER ARENA */
.arena{position:relative;display:flex;flex-direction:column;overflow:hidden;}
#arena-canvas{position:absolute;inset:0;width:100%;height:100%;}

/* EXPANSION 2: CINEMATIC TENSION ‚Äî table redness overlay */
.tension-overlay{
  position:absolute;inset:0;z-index:7;pointer-events:none;
  background:radial-gradient(ellipse at 50% 60%,transparent 25%,rgba(140,30,30,0) 100%);
  opacity:0;transition:opacity 1.5s ease;
}
.tension-overlay.danger{
  background:radial-gradient(ellipse at 50% 60%,transparent 20%,rgba(120,20,20,0.35) 100%);
  opacity:1;
}
.tension-overlay.extreme{
  background:radial-gradient(ellipse at 50% 60%,transparent 15%,rgba(140,20,20,0.55) 100%);
  opacity:1;animation:tensionPulse 1.8s ease-in-out infinite;
}
@keyframes tensionPulse{0%,100%{opacity:0.7}50%{opacity:1;}}

/* SLOW-ROLL CINEMATIC FLASH */
.slowroll-flash{
  position:absolute;inset:0;z-index:6;pointer-events:none;
  background:rgba(200,80,20,0);transition:background 0.15s ease;
}
.slowroll-flash.flash{background:rgba(200,80,20,0.04);}

.turn-pill{position:absolute;top:18px;left:50%;transform:translateX(-50%);background:rgba(8,7,9,0.88);backdrop-filter:blur(12px);border:1px solid var(--border2);border-radius:32px;padding:7px 20px;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--text2);z-index:10;transition:all 0.3s ease;white-space:nowrap;}
.turn-pill.player-turn{border-color:rgba(200,168,75,0.4);color:var(--gold);}
.turn-pill.reroll-turn{border-color:rgba(200,100,20,0.5);color:#ffb060;}

/* REROLL INDICATOR */
.reroll-indicator{position:absolute;top:62px;left:50%;transform:translateX(-50%);background:rgba(140,60,20,0.92);backdrop-filter:blur(8px);border:1px solid rgba(220,120,40,0.6);border-radius:20px;padding:6px 22px;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:#ffb060;z-index:11;white-space:nowrap;opacity:0;transition:opacity 0.25s ease;font-family:'DM Mono',monospace;}
.reroll-indicator.show{opacity:1;}
.reroll-indicator .reroll-count{display:inline-block;background:rgba(255,255,255,0.12);border-radius:6px;padding:1px 7px;margin-left:6px;font-weight:700;}

/* DICE STAGE */
.dice-stage{position:absolute;top:50%;left:50%;transform:translate(-50%,-52%);display:flex;gap:16px;align-items:center;justify-content:center;z-index:10;transition:opacity 0.25s ease;}
.dice-stage.fading{opacity:0.3;}

/* EXPANSION 2: SLOW-ROLL CINEMATIC ‚Äî dice stage grows slightly */
.dice-stage.slow-tension{transform:translate(-50%,-52%) scale(1.06);transition:transform 0.8s cubic-bezier(0.34,1.2,0.64,1),opacity 0.25s ease;}

/* 3D CSS DICE */
.die-wrap{width:72px;height:72px;perspective:300px;cursor:default;}
.die-3d{width:72px;height:72px;position:relative;transform-style:preserve-3d;transform:rotateX(0deg) rotateY(0deg) rotateZ(0deg);}
.die-3d.rolling{transition:none;}
.d-face{position:absolute;width:72px;height:72px;background:linear-gradient(145deg,#201a14,#140f0a);border:1px solid rgba(200,168,75,0.18);border-radius:14px;display:flex;align-items:center;justify-content:center;backface-visibility:hidden;box-shadow:inset 0 1px 0 rgba(255,255,255,0.04);}
/* EXPANSION 2: Cinematic tension makes dice face border glow red */
.die-3d.tense .d-face{border-color:rgba(180,40,40,0.4);box-shadow:inset 0 1px 0 rgba(255,80,80,0.04),0 0 12px rgba(140,30,30,0.15);}
.f-front{transform:translateZ(36px);} .f-back{transform:rotateY(180deg) translateZ(36px);} .f-top{transform:rotateX(90deg) translateZ(36px);} .f-bottom{transform:rotateX(-90deg) translateZ(36px);} .f-right{transform:rotateY(90deg) translateZ(36px);} .f-left{transform:rotateY(-90deg) translateZ(36px);}
.pip-grid{display:grid;grid-template-columns:1fr 1fr 1fr;grid-template-rows:1fr 1fr 1fr;width:50px;height:50px;}
.pip-cell{display:flex;align-items:center;justify-content:center;}
.pip{width:9px;height:9px;border-radius:50%;background:radial-gradient(circle,#e8c870,#c8a84b);box-shadow:0 0 6px rgba(200,168,75,0.5);}
/* Tense pips go red */
.die-3d.tense .pip{background:radial-gradient(circle,#f0a0a0,#c05050);box-shadow:0 0 6px rgba(200,50,50,0.5);}

/* RESOLUTION BANNER */
.res-banner{position:absolute;bottom:0;left:0;right:0;height:70px;display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:36px;letter-spacing:8px;transform:translateY(100%);transition:transform 0.38s cubic-bezier(0.34,1.2,0.64,1);z-index:15;}
.res-banner.show{transform:translateY(0);}
.res-win{background:rgba(74,140,98,0.18);border-top:1px solid rgba(74,140,98,0.35);color:#6ab88a;}
.res-loss{background:rgba(140,64,64,0.18);border-top:1px solid rgba(140,64,64,0.35);color:#c07070;}
.res-point{background:rgba(90,90,50,0.18);border-top:1px solid rgba(200,168,75,0.25);color:#c8a84b;}
.res-reroll{background:rgba(80,50,10,0.25);border-top:1px solid rgba(160,90,20,0.4);color:#c07830;}
.res-autowin{background:rgba(200,148,30,0.2);border-top:1px solid rgba(200,168,75,0.5);color:var(--gold2);}
.res-autoloss{background:rgba(80,20,20,0.25);border-top:1px solid rgba(140,40,40,0.5);color:#a06060;}
.res-triple{background:rgba(60,80,160,0.2);border-top:1px solid rgba(80,100,200,0.4);color:#a0b0f0;}

/* EXPANSION 3: BOT TABLE SHOWDOWN BANNER */
.showdown-banner{
  position:absolute;top:0;left:0;right:0;bottom:0;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  z-index:20;pointer-events:none;
  opacity:0;transition:opacity 0.4s;
  background:rgba(5,4,6,0.92);backdrop-filter:blur(4px);
}
.showdown-banner.show{opacity:1;}
.showdown-title{font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:6px;color:var(--text3);text-transform:uppercase;margin-bottom:24px;}
.showdown-results{display:flex;gap:20px;align-items:flex-end;margin-bottom:20px;flex-wrap:wrap;justify-content:center;}
.showdown-entry{
  padding:14px 18px;border-radius:14px;border:1px solid var(--border);
  background:var(--surface);text-align:center;min-width:90px;
  transition:all 0.4s cubic-bezier(0.34,1.2,0.64,1);
}
.showdown-entry.winner{
  border-color:var(--gold);background:rgba(200,168,75,0.1);
  transform:scale(1.12) translateY(-8px);
  box-shadow:0 16px 40px rgba(200,168,75,0.15);
}
.showdown-entry.loser{opacity:0.4;filter:grayscale(0.6);}
.showdown-entry.draw{border-color:rgba(100,100,200,0.5);background:rgba(80,80,180,0.08);}
.se-name{font-size:9px;color:var(--text2);letter-spacing:1px;margin-bottom:6px;}
.se-roll{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:2px;color:var(--text);line-height:1.1;}
.se-type{font-size:8px;letter-spacing:1px;color:var(--text3);margin-top:3px;}
.showdown-winner-text{font-family:'Bebas Neue',sans-serif;font-size:32px;letter-spacing:6px;color:var(--gold2);}
.showdown-winner-sub{font-size:9px;letter-spacing:3px;color:var(--text2);margin-top:4px;}

.streak-badge{position:absolute;top:18px;right:18px;z-index:10;padding:6px 14px;border-radius:10px;background:rgba(200,168,75,0.1);border:1px solid rgba(200,168,75,0.25);font-size:10px;font-family:'DM Mono',monospace;color:var(--gold);transition:all 0.3s;opacity:0;}
.streak-badge.show{opacity:1;}
.point-display{position:absolute;top:18px;left:50%;transform:translateX(-50%);margin-top:40px;font-family:'DM Mono',monospace;font-size:11px;color:var(--text2);letter-spacing:2px;z-index:10;white-space:nowrap;transition:opacity 0.3s;}
.point-display.has-point{color:var(--gold);}

/* EXPANSION 2: Slow-roll tension label */
.slowroll-label{position:absolute;bottom:90px;left:50%;transform:translateX(-50%);font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--red2);z-index:12;opacity:0;transition:opacity 0.4s;font-family:'DM Mono',monospace;}
.slowroll-label.show{opacity:1;animation:sevenWarn 1.6s ease-in-out infinite;}
@keyframes sevenWarn{0%,100%{color:var(--red2)}50%{color:#e06060;}}

.obj-tracker{position:absolute;bottom:110px;left:50%;transform:translateX(-50%);z-index:15;background:rgba(8,7,9,0.88);backdrop-filter:blur(8px);border:1px solid var(--border);border-radius:12px;padding:8px 16px;display:flex;align-items:center;gap:12px;transition:opacity 0.3s;}
.obj-tracker.hide{opacity:0;pointer-events:none;}
.obj-dot{width:6px;height:6px;border-radius:50%;background:var(--text3);}
.obj-dot.complete{background:var(--green);}
.obj-dot.active-obj{background:var(--gold);}
.obj-text{font-size:9px;color:var(--text2);letter-spacing:1px;}
.obj-prog{font-family:'DM Mono',monospace;font-size:10px;color:var(--gold);}

/* RIGHT PROB PANEL */
.prob-panel{display:flex;flex-direction:column;border-left:1px solid var(--border);background:rgba(8,7,9,0.75);backdrop-filter:blur(12px);overflow:hidden;}
.prob-hdr{padding:14px 18px 8px;font-size:8px;letter-spacing:3px;text-transform:uppercase;color:var(--text3);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
.prob-hdr span{color:var(--text2);font-size:9px;letter-spacing:1px;}
.prob-body{flex:1;padding:16px;overflow-y:auto;display:flex;flex-direction:column;gap:16px;}
.prob-sect{padding-bottom:14px;border-bottom:1px solid rgba(255,255,255,0.03);}
.prob-sect:last-child{border-bottom:none;}
.p-label{font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--text3);margin-bottom:5px;}
.p-val{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:2px;color:var(--text);line-height:1;}
.p-sub{font-size:10px;color:var(--text2);margin-top:2px;}
.dual-track{display:flex;height:6px;border-radius:3px;overflow:hidden;margin-top:8px;gap:1px;}
.dual-a{background:linear-gradient(90deg,#2a5c3a,#4a8c62);border-radius:3px 0 0 3px;transition:width 0.6s ease;}
.dual-b{background:linear-gradient(90deg,#5a2a2a,#8c4040);border-radius:0 3px 3px 0;flex:1;}
.dual-labels{display:flex;justify-content:space-between;margin-top:4px;}
.dual-labels span{font-size:8px;color:var(--text3);}
.str-track{height:4px;background:rgba(255,255,255,0.04);border-radius:2px;overflow:hidden;margin-top:8px;}
.str-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,#3a4a7a,var(--gold));transition:width 0.6s ease;}
.mini-dist{display:flex;align-items:flex-end;gap:2px;height:40px;margin-top:8px;}
.dist-bar{flex:1;border-radius:2px 2px 0 0;background:rgba(255,255,255,0.08);position:relative;transition:height 0.5s ease;min-height:2px;}
.dist-bar.active-sum{background:var(--gold);opacity:0.8;}
.dist-bar.seven-bar{background:var(--red2);opacity:0.7;}
.roll-chips{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px;}
.r-chip{width:26px;height:26px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-family:'DM Mono',monospace;font-size:10px;transition:all 0.2s;}
.r-chip-win{background:rgba(74,140,98,0.2);color:#6ab88a;border:1px solid rgba(74,140,98,0.3);}
.r-chip-loss{background:rgba(140,64,64,0.2);color:var(--red2);border:1px solid rgba(140,64,64,0.3);}
.r-chip-point{background:rgba(200,168,75,0.15);color:var(--gold);border:1px solid rgba(200,168,75,0.25);}
.r-chip-reroll{background:rgba(120,70,10,0.25);color:#c07830;border:1px solid rgba(160,90,20,0.3);}
.ev-row{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid rgba(255,255,255,0.025);}
.ev-name{font-size:10px;color:var(--text2);}
.ev-val{font-family:'DM Mono',monospace;font-size:10px;color:var(--text);}

/* BOTTOM CONTROL */
.control-bar{position:relative;z-index:20;height:110px;flex-shrink:0;background:rgba(8,7,9,0.92);backdrop-filter:blur(16px);border-top:1px solid var(--border);display:flex;align-items:center;justify-content:center;gap:24px;padding:0 24px;}
.ctrl-btn{height:38px;padding:0 18px;border-radius:10px;border:1px solid var(--border);background:var(--surface);color:var(--text2);font-size:9px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all 0.18s;font-family:'Syne',sans-serif;font-weight:600;}
.ctrl-btn:hover:not(:disabled){border-color:var(--border2);color:var(--text);}
.ctrl-btn:disabled{opacity:0.25;cursor:not-allowed;}
.ctrl-btn.toggled{border-color:rgba(200,168,75,0.4);color:var(--gold);}
.roll-btn{width:88px;height:88px;border-radius:50%;background:radial-gradient(circle at 38% 32%,#28200e,#160e04);border:1px solid rgba(200,168,75,0.22);box-shadow:0 4px 24px rgba(0,0,0,0.7),inset 0 1px 0 rgba(200,168,75,0.08);color:var(--text);font-size:9px;letter-spacing:3px;text-transform:uppercase;cursor:pointer;transition:all 0.15s ease;font-family:'Syne',sans-serif;font-weight:700;position:relative;}
.roll-btn::before{content:'';position:absolute;inset:5px;border-radius:50%;border:1px solid rgba(255,255,255,0.03);}
.roll-btn:hover:not(:disabled){box-shadow:0 6px 32px rgba(0,0,0,0.8),0 0 20px rgba(200,168,75,0.06),inset 0 1px 0 rgba(200,168,75,0.12);border-color:rgba(200,168,75,0.38);}
.roll-btn:active:not(:disabled){transform:scale(0.95);}
.roll-btn:disabled{opacity:0.3;cursor:not-allowed;}
.roll-btn.rerolling{border-color:rgba(200,100,20,0.6);box-shadow:0 0 24px rgba(180,90,10,0.25),0 4px 24px rgba(0,0,0,0.7),inset 0 1px 0 rgba(200,130,40,0.15);animation:rerollPulse 1.2s ease-in-out infinite;}
.speed-sel{background:var(--surface2);border:1px solid var(--border);color:var(--text2);border-radius:10px;padding:8px 12px;font-size:9px;font-family:'Syne',sans-serif;font-weight:600;cursor:pointer;appearance:none;letter-spacing:1px;}

/* CEE-LO BOT TABLE: round indicator */
.round-badge{
  position:absolute;bottom:88px;left:50%;transform:translateX(-50%);
  background:rgba(8,7,9,0.88);backdrop-filter:blur(8px);border:1px solid var(--border2);
  border-radius:20px;padding:5px 18px;font-size:9px;letter-spacing:2px;text-transform:uppercase;
  color:var(--text2);z-index:15;white-space:nowrap;transition:opacity 0.3s;opacity:0;
  font-family:'DM Mono',monospace;
}
.round-badge.show{opacity:1;}

/* =====================================================  REALITY SCREEN  ===================================================== */
#scr-reality{background:radial-gradient(ellipse 70% 50% at 50% 0%,#130f06,var(--bg));overflow:hidden;}
.reality-layout{display:grid;grid-template-columns:1fr 1fr;grid-template-rows:auto 1fr auto;height:100%;gap:0;}
.reality-hdr{grid-column:1/-1;padding:32px 40px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:flex-end;}
.reality-title{font-family:'Bebas Neue',sans-serif;font-size:52px;letter-spacing:4px;line-height:1;}
.reality-sub{font-size:9px;letter-spacing:3px;color:var(--text2);text-transform:uppercase;margin-top:4px;}
.r-pane{padding:28px 32px;overflow-y:auto;border-right:1px solid var(--border);}
.r-pane:last-of-type{border-right:none;}
.r-pane-title{font-size:8px;letter-spacing:3px;text-transform:uppercase;color:var(--text3);margin-bottom:18px;}
.r-row{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid rgba(255,255,255,0.03);}
.r-row:last-child{border-bottom:none;}
.r-name{font-size:11px;color:var(--text2);}
.r-actual{font-family:'DM Mono',monospace;font-size:13px;color:var(--text);}
.r-expected{font-family:'DM Mono',monospace;font-size:10px;color:var(--text3);}
.heat-row{margin-bottom:6px;}
.heat-lbl{display:flex;justify-content:space-between;font-size:9px;color:var(--text3);margin-bottom:3px;}
.heat-track{height:5px;background:rgba(255,255,255,0.04);border-radius:2px;overflow:hidden;}
.heat-fill{height:100%;border-radius:2px;transition:width 0.5s ease;}
.heat-under{background:linear-gradient(90deg,#3a3a6a,#5a5aaa);}
.heat-over{background:linear-gradient(90deg,var(--gold),#e88a20);}
.heat-match{background:linear-gradient(90deg,#2a6a3a,#4aaa62);}
.reality-msg{grid-column:1/-1;padding:24px 32px;border-top:1px solid var(--border);background:rgba(200,168,75,0.04);}
.reality-msg-title{font-size:13px;font-weight:700;color:var(--gold);margin-bottom:8px;}
.reality-msg-body{font-size:12px;color:var(--text2);line-height:1.7;max-width:860px;}

/* =====================================================  STATS  ===================================================== */
#scr-stats{background:var(--bg);overflow-y:auto;padding:40px;}
.stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;max-width:1200px;margin:32px auto 0;}
.s-card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:22px;}
.s-card-lbl{font-size:8px;letter-spacing:3px;text-transform:uppercase;color:var(--text3);margin-bottom:10px;}
.s-card-val{font-family:'Bebas Neue',sans-serif;font-size:42px;letter-spacing:2px;line-height:1;color:var(--text);}
.s-card-sub{font-size:10px;color:var(--text2);margin-top:5px;}

/* =====================================================  URGE LOG  ===================================================== */
#scr-urge{background:radial-gradient(ellipse at 50% 60%,#100d0a,var(--bg));align-items:center;justify-content:center;}
.urge-card{width:100%;max-width:520px;background:rgba(13,11,15,0.95);border:1px solid var(--border2);border-radius:24px;padding:40px;max-height:90vh;overflow-y:auto;}
.urge-hdr-title{font-family:'Bebas Neue',sans-serif;font-size:40px;letter-spacing:4px;margin-bottom:4px;}
.urge-hdr-sub{font-size:9px;letter-spacing:3px;color:var(--text2);text-transform:uppercase;margin-bottom:28px;}
.u-field{margin-bottom:22px;}
.u-label{font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--text3);display:block;margin-bottom:8px;}
.mood-row{display:flex;gap:10px;}
.mood-btn{width:42px;height:42px;border-radius:12px;border:1px solid var(--border);background:var(--surface);font-size:18px;cursor:pointer;transition:all 0.18s;display:flex;align-items:center;justify-content:center;}
.mood-btn:hover,.mood-btn.sel{border-color:rgba(200,168,75,0.45);background:rgba(200,168,75,0.1);}
.u-slider{width:100%;accent-color:var(--gold);margin-top:4px;}
.u-select,.u-textarea{width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:12px;padding:11px 14px;font-family:'Syne',sans-serif;font-size:12px;}
.u-select{appearance:none;}
.u-textarea{resize:none;height:72px;}
.u-submit{width:100%;height:50px;border-radius:14px;background:rgba(200,168,75,0.1);border:1px solid rgba(200,168,75,0.28);color:var(--gold2);font-family:'Syne',sans-serif;font-size:10px;font-weight:700;letter-spacing:3px;text-transform:uppercase;cursor:pointer;transition:all 0.18s;margin-top:4px;}
.u-submit:hover{background:rgba(200,168,75,0.16);}

/* =====================================================  COOLDOWN  ===================================================== */
#scr-cooldown{align-items:center;justify-content:center;background:radial-gradient(ellipse at 50% 50%,#100c08,#050406);}
.cd-card{width:460px;text-align:center;padding:52px 48px;background:rgba(10,8,6,0.97);border:1px solid rgba(255,255,255,0.05);border-radius:24px;box-shadow:0 40px 100px rgba(0,0,0,0.9);}
.cd-icon{font-size:44px;margin-bottom:20px;opacity:0.5;}
.cd-title{font-family:'Bebas Neue',sans-serif;font-size:44px;letter-spacing:4px;margin-bottom:8px;}
.cd-sub{font-size:11px;color:var(--text2);line-height:1.7;margin-bottom:28px;}
.cd-timer{font-family:'Bebas Neue',sans-serif;font-size:56px;color:var(--text2);letter-spacing:4px;margin-bottom:28px;}
.cd-actions{display:flex;gap:10px;justify-content:center;}
.cd-btn{padding:10px 22px;border-radius:12px;border:1px solid var(--border2);background:var(--surface);color:var(--text2);font-size:9px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;font-family:'Syne',sans-serif;font-weight:600;transition:all 0.18s;}
.cd-btn:hover{border-color:rgba(255,255,255,0.18);color:var(--text);}

/* TOASTS */
.lvl-toast{position:fixed;top:80px;left:50%;transform:translateX(-50%) scale(0.8);background:rgba(10,8,6,0.95);border:1px solid rgba(200,168,75,0.4);border-radius:16px;padding:16px 28px;display:flex;align-items:center;gap:14px;z-index:100;opacity:0;transition:all 0.35s cubic-bezier(0.34,1.4,0.64,1);pointer-events:none;}
.lvl-toast.show{opacity:1;transform:translateX(-50%) scale(1);}
.lvl-toast-icon{font-size:24px;}
.lvl-toast-text{font-size:12px;color:var(--text);}
.lvl-toast-text strong{color:var(--gold2);font-weight:700;}
.toast{position:fixed;bottom:130px;left:50%;transform:translateX(-50%) translateY(10px);background:rgba(10,8,6,0.95);border:1px solid var(--border2);border-radius:12px;padding:10px 22px;font-size:11px;color:var(--text2);letter-spacing:0.5px;opacity:0;transition:all 0.28s ease;z-index:200;pointer-events:none;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.back-btn{position:absolute;top:20px;left:20px;z-index:50;padding:7px 14px;border-radius:9px;border:1px solid var(--border);background:rgba(8,7,9,0.85);color:var(--text2);font-size:9px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;backdrop-filter:blur(8px);font-family:'Syne',sans-serif;font-weight:600;transition:all 0.18s;}
.back-btn:hover{color:var(--text);border-color:var(--border2);}
.scr-hdr{max-width:1200px;margin:0 auto;padding:32px 40px 20px;}
.scr-hdr h1{font-family:'Bebas Neue',sans-serif;font-size:48px;letter-spacing:4px;}
.scr-hdr p{font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--text3);margin-top:4px;}

@keyframes rerollPulse{0%,100%{box-shadow:0 0 16px rgba(180,90,10,0.2),0 4px 24px rgba(0,0,0,0.7)}50%{box-shadow:0 0 36px rgba(200,110,20,0.45),0 4px 24px rgba(0,0,0,0.7)}}
@keyframes rerollBubblePulse{0%{transform:scale(1)}50%{transform:scale(1.15)}100%{transform:scale(1)}}
@keyframes popIn{0%{transform:scale(0.7);opacity:0}100%{transform:scale(1);opacity:1}}
@keyframes showdownEntry{0%{opacity:0;transform:translateY(12px)}100%{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>

<!-- HOME -->
<div class="screen active" id="scr-home">
  <div class="home-wrap">
    <div class="logo-wrap">
      <div class="logo-main">DICE <em>DETOX</em>‚Ñ¢</div>
      <div class="logo-ver">V2 ‚Äî LUXURY ARCADE ENGINE</div>
      <div class="logo-sub">Behavioral Control Simulator</div>
    </div>
    <div class="xp-home" id="home-xp-area">
      <div class="xp-home-label">
        <span id="home-level-lbl">Level 1</span>
        <span id="home-xp-lbl">0 / 100 XP</span>
      </div>
      <div class="xp-home-track"><div class="xp-home-fill" id="home-xp-fill" style="width:0%"></div></div>
    </div>
    <div class="home-divider"></div>
    <div class="mode-grid">
      <div class="mode-card selected" id="mc-street" onclick="G.selectMode('street')">
        <div class="mode-icon">üé≤</div>
        <div class="mode-name">Street Dice</div>
        <div class="mode-desc">2d6 ¬∑ Come-Out & Point</div>
      </div>
      <div class="mode-card" id="mc-ceelo" onclick="G.selectMode('ceelo')">
        <div class="mode-icon">üéØ</div>
        <div class="mode-name">Cee-Lo Solo</div>
        <div class="mode-desc">3d6 ¬∑ Full Hierarchy</div>
      </div>
      <div class="mode-card" id="mc-bot" onclick="G.selectMode('bot')">
        <div class="mode-icon">ü§ñ</div>
        <div class="mode-name">Bot Table</div>
        <div class="mode-desc">Street ¬∑ 4-player AI</div>
      </div>
      <div class="mode-card" id="mc-botceelo" onclick="G.selectMode('botceelo')">
        <div class="mode-icon">üÉè</div>
        <div class="mode-name">Bot Cee-Lo</div>
        <div class="mode-desc">3d6 ¬∑ Showdown format</div>
        <div class="mode-badge">NEW</div>
      </div>
    </div>
    <button class="enter-btn" onclick="G.enterGame()">ENTER SESSION</button>
  </div>
  <nav class="home-nav">
    <button class="home-nav-btn" onclick="G.showScreen('stats')">Stats</button>
    <button class="home-nav-btn" onclick="G.showScreen('reality')">Reality</button>
    <button class="home-nav-btn" onclick="G.showScreen('urge')">Urge Log</button>
    <button class="home-nav-btn" onclick="G.showScreen('cooldown')">Cooldown</button>
  </nav>
</div>

<!-- GAME -->
<div class="screen" id="scr-game">
  <canvas id="alley-bg"></canvas>
  <div class="top-hud">
    <div class="hud-left">
      <div class="hud-mode-badge" id="hud-mode">STREET DICE</div>
      <div class="hud-level">
        <div class="hud-level-num" id="hud-level">LVL 1</div>
        <div class="hud-xp-bar"><div class="hud-xp-fill" id="hud-xp-fill" style="width:0%"></div></div>
      </div>
    </div>
    <div class="hud-center">
      <div class="hud-timer-row">
        <div class="timer-ring-wrap">
          <svg width="40" height="40" viewBox="0 0 40 40">
            <circle class="timer-ring-track" cx="20" cy="20" r="18"/>
            <circle class="timer-ring-fill" id="timer-ring" cx="20" cy="20" r="18"/>
          </svg>
          <div class="timer-ring-text" id="timer-text">0:00</div>
        </div>
      </div>
      <div class="hud-objective" id="hud-obj">‚Äî</div>
    </div>
    <div class="hud-right">
      <div class="hud-stat-block">
        <div class="hud-stat-label">Bankroll</div>
        <div class="hud-stat-val" id="hud-bank">$1,000</div>
      </div>
      <div class="stim-col">
        <div class="hud-stat-label" style="text-align:right">Stimulation</div>
        <div class="stim-track"><div class="stim-fill" id="stim-fill" style="width:100%"></div></div>
      </div>
      <button class="ctrl-btn" onclick="G.showScreen('home')" style="font-size:8px;">EXIT</button>
    </div>
  </div>

  <div class="game-body">
    <div class="bot-panel">
      <div class="bot-panel-hdr">
        <div class="bot-panel-hdr-title">Players</div>
        <div class="bot-panel-mode" id="bot-panel-mode-badge">‚Äî</div>
      </div>
      <div class="bot-list" id="bot-list"></div>
      <!-- EXPANSION 1: LIVE SCOREBOARD -->
      <div class="scoreboard" id="scoreboard">
        <div class="scoreboard-hdr">Standings</div>
        <div id="scoreboard-rows"></div>
      </div>
    </div>

    <div class="arena" id="arena">
      <canvas id="arena-canvas"></canvas>
      <!-- EXPANSION 2: CINEMATIC TENSION LAYERS -->
      <div class="tension-overlay" id="tension-overlay"></div>
      <div class="slowroll-flash" id="slowroll-flash"></div>

      <div class="turn-pill player-turn" id="turn-pill">‚ñ∂ YOUR TURN</div>
      <div class="reroll-indicator" id="reroll-indicator">
        REROLL REQUIRED <span class="reroll-count" id="reroll-count">0</span>
      </div>
      <div class="streak-badge" id="streak-badge">üî• 3 STREAK</div>
      <div class="point-display" id="point-display"></div>
      <div class="slowroll-label" id="slowroll-lbl">‚ö† SEVEN RISK HIGH</div>
      <div class="dice-stage" id="dice-stage"></div>
      <div class="round-badge" id="round-badge">ROUND 1</div>
      <div class="obj-tracker" id="obj-tracker">
        <div class="obj-dot active-obj" id="obj-dot"></div>
        <div class="obj-text" id="obj-text">Survive 3 points</div>
        <div class="obj-prog" id="obj-prog">0/3</div>
      </div>
      <!-- EXPANSION 3: BOT SHOWDOWN BANNER -->
      <div class="showdown-banner" id="showdown-banner">
        <div class="showdown-title">Round Result</div>
        <div class="showdown-results" id="showdown-results"></div>
        <div class="showdown-winner-text" id="showdown-winner-text"></div>
        <div class="showdown-winner-sub" id="showdown-winner-sub"></div>
      </div>
      <div class="res-banner" id="res-banner">WIN</div>
    </div>

    <div class="prob-panel">
      <div class="prob-hdr">Probability Intelligence<span id="prob-mode-lbl">STREET</span></div>
      <div class="prob-body" id="prob-body"></div>
    </div>
  </div>

  <div class="control-bar">
    <button class="ctrl-btn" id="btn-auto" onclick="G.toggleAuto()">Auto Play</button>
    <button class="ctrl-btn" onclick="G.showScreen('reality')">Reality</button>
    <button class="roll-btn" id="roll-btn" onclick="G.roll()">ROLL</button>
    <select class="speed-sel" id="speed-sel">
      <option value="1">Normal</option>
      <option value="0.5">Fast</option>
      <option value="2">Slow</option>
    </select>
    <button class="ctrl-btn" onclick="G.resetSession()">Reset</button>
  </div>
</div>

<!-- REALITY -->
<div class="screen" id="scr-reality">
  <button class="back-btn" onclick="G.showScreen('home')">‚Üê Back</button>
  <div class="reality-layout">
    <div class="reality-hdr">
      <div>
        <div class="reality-title">Reality Mode</div>
        <div class="reality-sub">Unfiltered statistical truth</div>
      </div>
      <div style="text-align:right">
        <div style="font-family:'DM Mono',monospace;font-size:24px;color:var(--text)" id="r-total-big">0</div>
        <div style="font-size:9px;letter-spacing:2px;color:var(--text3)">TOTAL ROLLS</div>
      </div>
    </div>
    <div class="r-pane" id="r-dist-pane"><div class="r-pane-title">Dice Distribution</div></div>
    <div class="r-pane" id="r-metrics-pane"><div class="r-pane-title">Key Metrics</div></div>
    <div class="reality-msg">
      <div class="reality-msg-title">The Mathematics of Randomness</div>
      <div class="reality-msg-body">Street dice carry a house edge of ~1.4% on pass-line bets. The feeling of "momentum" is the Gambler's Fallacy ‚Äî dice have no memory. Every roll is statistically independent. Over 1,000 rolls, any hot streak regresses toward the mathematical mean: 16.67% sevens, 13.89% sixes, and so on. No throwing technique, ritual, or "system" changes the probability distribution. This simulator exists so you can exhaust the urge here ‚Äî safely, with no financial consequence.</div>
    </div>
  </div>
</div>

<!-- STATS -->
<div class="screen" id="scr-stats">
  <button class="back-btn" onclick="G.showScreen('home')">‚Üê Back</button>
  <div class="scr-hdr"><h1>Long-Term Stats</h1><p>All-sessions lifetime data</p></div>
  <div class="stats-grid" id="stats-grid"></div>
</div>

<!-- URGE LOG -->
<div class="screen" id="scr-urge">
  <button class="back-btn" onclick="G.showScreen('home')">‚Üê Back</button>
  <div class="urge-card">
    <div class="urge-hdr-title">Urge Log</div>
    <div class="urge-hdr-sub">What brought you here today</div>
    <div class="u-field">
      <label class="u-label">Current Mood</label>
      <div class="mood-row">
        <button class="mood-btn" onclick="G.selectMood(this,'calm')" title="Calm">üòå</button>
        <button class="mood-btn" onclick="G.selectMood(this,'stressed')" title="Stressed">üòü</button>
        <button class="mood-btn" onclick="G.selectMood(this,'bored')" title="Bored">üòë</button>
        <button class="mood-btn" onclick="G.selectMood(this,'restless')" title="Restless">üò§</button>
        <button class="mood-btn" onclick="G.selectMood(this,'excited')" title="Excited">üî•</button>
        <button class="mood-btn" onclick="G.selectMood(this,'lonely')" title="Lonely">üòî</button>
      </div>
    </div>
    <div class="u-field">
      <label class="u-label">Stress Level (1‚Äì10): <span id="stress-num">5</span></label>
      <input type="range" min="1" max="10" value="5" class="u-slider" oninput="document.getElementById('stress-num').textContent=this.value">
    </div>
    <div class="u-field">
      <label class="u-label">Primary Trigger</label>
      <select class="u-select">
        <option>Select...</option><option>Financial pressure</option><option>Boredom / idle time</option>
        <option>Social environment</option><option>Emotional distress</option><option>Habit / routine</option>
        <option>Advertisement / media exposure</option><option>Win memory / "last time" thinking</option><option>Other</option>
      </select>
    </div>
    <div class="u-field">
      <label class="u-label">Notes (optional)</label>
      <textarea class="u-textarea" placeholder="What's on your mind right now..."></textarea>
    </div>
    <button class="u-submit" onclick="G.submitUrge()">Log Entry & Play Instead</button>
  </div>
</div>

<!-- COOLDOWN -->
<div class="screen" id="scr-cooldown">
  <div class="cd-card">
    <div class="cd-icon">üåô</div>
    <div class="cd-title">Cooldown Active</div>
    <div class="cd-sub">Neural stimulation requires reset.<br>Roll controls will return after the timer.</div>
    <div class="cd-timer" id="cd-timer">05:00</div>
    <div class="cd-actions">
      <button class="cd-btn" onclick="G.showScreen('stats')">View Stats</button>
      <button class="cd-btn" onclick="G.showScreen('reality')">Reality Mode</button>
      <button class="cd-btn" onclick="G.showScreen('home')">‚Üê Home</button>
    </div>
  </div>
</div>

<div class="lvl-toast" id="lvl-toast">
  <div class="lvl-toast-icon">‚¨Ü</div>
  <div class="lvl-toast-text"><strong id="lvl-toast-text">Level 2</strong> ‚Äî Keep going.</div>
</div>
<div class="toast" id="toast"></div>

<script>
'use strict';
/* =====================================================
   DICE DETOX V2 ‚Äî FULL SYSTEM ENGINE
   
   THREE PREMIUM EXPANSIONS:
   1. LIVE SCOREBOARD ‚Äî Real-time player standings with
      wins/losses/bankroll, auto-ranked, leader highlighted.
   
   2. CINEMATIC TENSION SYSTEM ‚Äî When in point phase,
      visual red tension builds based on 7-probability.
      Dice glow red, table vignette deepens, pip color shifts.
      Near-critical points trigger slow-roll animation scaling.
   
   3. CEE-LO BOT TABLE SHOWDOWN ‚Äî New 'botceelo' mode where
      all 5 players (you + 4 bots) roll Cee-Lo each round.
      Everyone keeps rerolling until valid. Then a full
      comparative showdown reveals winner by hierarchy ranking.
      Highest-ranked result wins the round. Full reroll logic
      preserved per player.
   ===================================================== */

/* ‚îÄ‚îÄ MODULE: SECURE RNG ‚îÄ‚îÄ */
const RNG = (() => {
  let seed = Date.now() ^ (Math.random() * 0xFFFFFFFF | 0);
  function next() { seed ^= seed<<13; seed ^= seed>>17; seed ^= seed<<5; return (seed>>>0)/4294967296; }
  return {
    d6()          { return Math.floor(next()*6)+1; },
    range(lo,hi)  { return lo+Math.floor(next()*(hi-lo+1)); },
    float(lo,hi)  { return lo+next()*(hi-lo); },
    reseed()      { seed = Date.now()^(Math.random()*0xFFFFFFFF|0); }
  };
})();

/* ‚îÄ‚îÄ MODULE: PROBABILITY ENGINE ‚îÄ‚îÄ */
const Prob = (() => {
  const WAYS = {2:1,3:2,4:3,5:4,6:5,7:6,8:5,9:4,10:3,11:2,12:1};
  const TOTAL = 36;

  function prob2d6(sum) { return (WAYS[sum]||0)/TOTAL; }
  function streetComeOut() {
    const pWin=(WAYS[7]+WAYS[11])/TOTAL, pLoss=(WAYS[2]+WAYS[3]+WAYS[12])/TOTAL;
    return {pWin,pLoss,pPoint:1-pWin-pLoss};
  }
  function streetPoint(pt) {
    const pP=WAYS[pt]/TOTAL, p7=WAYS[7]/TOTAL, pResolve=pP+p7;
    return {pWin:pP/pResolve,pWinAbs:pP,p7Abs:p7,pResolve,expectedRolls:1/pResolve};
  }

  // Cee-Lo combo counts (computed once)
  const CC = (() => {
    const c = {autowin:0,triple:0,point:{},autoloss:0,reroll:0};
    for(let a=1;a<=6;a++) for(let b=1;b<=6;b++) for(let d=1;d<=6;d++){
      const s=[a,b,d].sort((x,y)=>x-y);
      if(s[0]===4&&s[1]===5&&s[2]===6){c.autowin++;continue;}
      if(s[0]===1&&s[1]===2&&s[2]===3){c.autoloss++;continue;}
      if(s[0]===s[1]&&s[1]===s[2]){c.triple++;continue;}
      if(s[0]===s[1]||s[1]===s[2]||s[0]===s[2]){
        let sc; if(s[0]===s[1])sc=s[2]; else if(s[1]===s[2])sc=s[0]; else sc=s[1];
        c.point[sc]=(c.point[sc]||0)+1; continue;
      }
      c.reroll++;
    }
    return c;
  })();

  // Returns numeric strength rank (higher = better). Used for Showdown comparison.
  // autowin=700, triple N=600+N, point N=N(1-6), autoloss=0
  function ceeloRank(res) {
    if(res.type==='autowin')  return 700;
    if(res.type==='autoloss') return 0;
    if(res.type==='triple')   return 600+(res.triples||0);
    if(res.type==='point')    return res.score||0;
    return -1; // reroll ‚Äî shouldn't reach showdown
  }

  function ceeloStrength(res) {
    if(res.type==='autowin')  return {rank:1,stronger:0,pct:100,total:216};
    if(res.type==='autoloss') return {rank:14,stronger:215,pct:0,total:216};
    if(res.type==='triple'){
      const nAbove = (6-res.triples);
      return {rank:2+nAbove,stronger:CC.autowin+nAbove,pct:Math.round((1-(CC.autowin+nAbove)/216)*100),total:216};
    }
    if(res.type==='point'){
      const sc=res.score; let stronger=CC.autowin+CC.triple;
      for(let s=sc+1;s<=6;s++) stronger+=(CC.point[s]||0);
      return {rank:8+(6-sc),stronger,pct:Math.round((1-stronger/216)*100),total:216};
    }
    return {rank:13,stronger:210,pct:3,total:216};
  }

  return {prob2d6,streetComeOut,streetPoint,ceeloStrength,ceeloRank,WAYS,CC};
})();

/* ‚îÄ‚îÄ MODULE: STREET DICE RESOLVER ‚îÄ‚îÄ */
const StreetResolver = (() => {
  function resolve(d1,d2,phase,point) {
    const sum=d1+d2;
    if(phase==='comeout'){
      if(sum===7||sum===11) return {outcome:'win',sum,type:'natural'};
      if(sum===2||sum===3||sum===12) return {outcome:'loss',sum,type:'craps'};
      return {outcome:'point',sum,type:'establish'};
    }
    if(sum===point) return {outcome:'win',sum,type:'point_hit'};
    if(sum===7)     return {outcome:'loss',sum,type:'seven_out'};
    return          {outcome:'continue',sum,type:'point_phase'};
  }
  return {resolve};
})();

/* ‚îÄ‚îÄ MODULE: CEE-LO RESOLVER ‚îÄ‚îÄ */
const CeeloResolver = (() => {
  function resolve(d1,d2,d3) {
    const s=[d1,d2,d3].sort((a,b)=>a-b);
    if(s[0]===4&&s[1]===5&&s[2]===6) return {outcome:'autowin', type:'autowin', label:'4 ¬∑ 5 ¬∑ 6  AUTO WIN',  score:null};
    if(s[0]===1&&s[1]===2&&s[2]===3) return {outcome:'autoloss',type:'autoloss',label:'1 ¬∑ 2 ¬∑ 3  AUTO LOSS', score:null};
    if(s[0]===s[1]&&s[1]===s[2])     return {outcome:'win',     type:'triple',  label:`${s[0]}-${s[1]}-${s[2]}  TRIPS`, score:null,triples:s[0]};
    if(s[0]===s[1]&&s[1]!==s[2])     return {outcome:'point',   type:'point',   label:`PAIR ${s[0]}s ‚Äî POINT ${s[2]}`,   score:s[2]};
    if(s[1]===s[2]&&s[0]!==s[1])     return {outcome:'point',   type:'point',   label:`PAIR ${s[1]}s ‚Äî POINT ${s[0]}`,   score:s[0]};
    if(s[0]===s[2]&&s[0]!==s[1])     return {outcome:'point',   type:'point',   label:`PAIR ${s[0]}s ‚Äî POINT ${s[1]}`,   score:s[1]};
    return {outcome:'reroll',type:'reroll',label:`${d1} ¬∑ ${d2} ¬∑ ${d3}  REROLL`,score:null};
  }
  return {resolve};
})();

/* ‚îÄ‚îÄ MODULE: XP ENGINE ‚îÄ‚îÄ */
const XP = (() => {
  const LVL=[0,100,250,450,700,1000,1350,1750,2200,2700,3250,3850,4500,5200,5950,6750,7600,8500,9450,10450,11500,12600,13750,14950,16200,17500,18850,20250,21700,23200];
  function calcLevel(xp){
    for(let i=0;i<LVL.length-1;i++) if(xp<LVL[i+1]) return {level:i+1,current:xp-LVL[i],needed:LVL[i+1]-LVL[i],pct:(xp-LVL[i])/(LVL[i+1]-LVL[i])*100};
    return {level:30,current:0,needed:1,pct:100};
  }
  return {calcLevel};
})();

/* ‚îÄ‚îÄ MODULE: SESSION OBJECTIVE ENGINE ‚îÄ‚îÄ */
const ObjectiveEngine = (() => {
  const OBJ=[
    {id:'survive3', text:'Survive 3 points without 7',   target:3,  stat:'pointsSurvived', xp:50},
    {id:'roll20',   text:'Complete 20 rolls this session',target:20, stat:'sessionRolls',  xp:30},
    {id:'streak3',  text:'Win 3 in a row',                target:3,  stat:'currentStreak', xp:60},
    {id:'ceelo456', text:'Roll a 4-5-6 in Cee-Lo',        target:1,  stat:'ceeloAutowins', xp:80},
    {id:'no7for10', text:'10 rolls without a seven',      target:10, stat:'rollsWithoutSeven',xp:70},
    {id:'reroll5',  text:'Survive 5 rerolls in one game', target:5,  stat:'sessionRerolls',xp:40},
  ];
  let current=null;
  function pick(){current=OBJ[Math.floor(Math.random()*OBJ.length)];return current;}
  function get(){return current;}
  return {pick,get};
})();

/* ‚îÄ‚îÄ MODULE: DECAY ENGINE ‚îÄ‚îÄ */
const DecayEngine = (() => {
  let sessionMs=0;
  const MAX=30*60*1000, START=10*60*1000;
  function update(ms){
    sessionMs=ms;
    const r=Math.max(0,(ms-START))/(MAX-START), c=Math.min(r,1);
    document.documentElement.style.setProperty('--sat',1-c*0.45);
    document.documentElement.style.setProperty('--bri',1-c*0.12);
    return {stim:Math.max(0.05,1-c*0.85)};
  }
  function isExpired(){return sessionMs>=MAX;}
  return {update,isExpired};
})();

/* ‚îÄ‚îÄ MODULE: STATS ENGINE ‚îÄ‚îÄ */
const Stats = (() => {
  const s={
    totalRolls:0,sessionRolls:0,wins:0,losses:0,rerolls:0,
    sevenCount:0,pointsSurvived:0,rollsWithoutSeven:0,
    currentStreak:0,longestStreak:0,
    ceeloAutowins:0,sessionRerolls:0,
    bankroll:1000,startBankroll:1000,totalXP:0,sessions:1,
    dist:Object.fromEntries([2,3,4,5,6,7,8,9,10,11,12].map(n=>[n,0])),
    rollLog:[]
  };
  function record(roll){
    s.totalRolls++; s.sessionRolls++;
    if(roll.sum!==undefined){
      s.dist[roll.sum]=(s.dist[roll.sum]||0)+1;
      if(roll.sum===7){s.sevenCount++;s.rollsWithoutSeven=0;}else s.rollsWithoutSeven++;
    }
    if(roll.outcome==='win'){s.wins++;s.currentStreak++;s.longestStreak=Math.max(s.longestStreak,s.currentStreak);}
    if(roll.outcome==='loss'){s.losses++;s.currentStreak=0;}
    if(roll.outcome==='reroll'){s.rerolls++;s.sessionRerolls++;}
    if(roll.type==='point_hit') s.pointsSurvived++;
    if(roll.type==='autowin')   s.ceeloAutowins++;
    s.rollLog.push({...roll,ts:Date.now()});
    if(s.rollLog.length>500) s.rollLog.shift();
  }
  function addXP(n){s.totalXP+=n;return XP.calcLevel(s.totalXP);}
  function setBank(v){s.bankroll=v;}
  function get(){return s;}
  function reset(){s.sessionRolls=0;s.sessionRerolls=0;s.rollsWithoutSeven=0;s.currentStreak=0;s.sessions++;s.bankroll=1000;s.startBankroll=1000;}
  return {record,addXP,get,setBank,reset};
})();

/* ‚îÄ‚îÄ MODULE: BOT AI ENGINE ‚îÄ‚îÄ */
const BotAI = (() => {
  const BOTS=[
    {id:0,name:'üî• Hot Hand Mike',conf:0.78,tilt:0.15,bank:850, mood:'hot',   wins:3,losses:1,personality:'aggressive',
     lines:{win:['Lets go!','That\'s mine.','Stay hot.'],loss:['Shake it off.','Next one.','I\'m due.'],point:['I got this.','Locked in.'],reroll:['Come on...','One more.']}},
    {id:1,name:'üìä Stats Sam',    conf:0.55,tilt:0.08,bank:1120,mood:'neutral',wins:1,losses:1,personality:'analytical',
     lines:{win:['EV confirmed.','Math works.'],loss:['Variance.','Expected delta.'],point:['Positive EV zone.'],reroll:['Reroll ~50%.','Expected.']}},
    {id:2,name:'üòê Quiet Larry',  conf:0.42,tilt:0.20,bank:930, mood:'cool',  wins:1,losses:2,personality:'passive',
     lines:{win:['Mm.'],loss:['.'],point:['OK.'],reroll:['...']}},
    {id:3,name:'üò§ Tilt Tony',    conf:0.30,tilt:0.75,bank:340, mood:'tilt',  wins:0,losses:5,personality:'volatile',
     lines:{win:['FINALLY.','About time.'],loss:['Again?!','Unbelievable.'],point:['Whatever.'],reroll:['Oh come ON.','Again?!']}},
  ];
  const DELAYS={aggressive:[600,1400],analytical:[900,1800],passive:[1100,2200],volatile:[500,2600]};
  function getDelay(bot,sm){const[lo,hi]=DELAYS[bot.personality]||[800,2000];return Math.floor(RNG.range(lo,hi)/sm);}
  function getLine(bot,evt){const l=bot.lines[evt];if(!l||!l.length)return null;return l[RNG.range(0,l.length-1)];}
  function updateMood(bot,outcome){
    if(outcome==='win') {bot.conf=Math.min(1,bot.conf+0.08);bot.tilt=Math.max(0,bot.tilt-0.05);bot.wins++;}
    if(outcome==='loss'){bot.conf=Math.max(0,bot.conf-0.12);bot.tilt=Math.min(1,bot.tilt+0.15);bot.losses++;}
    if(bot.tilt>0.65)bot.mood='tilt';else if(bot.conf>0.7)bot.mood='hot';else if(bot.conf<0.35)bot.mood='neutral';else bot.mood='cool';
  }
  function updateBank(bot,outcome){
    if(outcome==='win') bot.bank+=RNG.range(60,150);
    if(outcome==='loss')bot.bank=Math.max(0,bot.bank-RNG.range(60,150));
  }
  function resetBots(){
    BOTS.forEach(b=>{b.conf=0.5;b.tilt=0.2;b.bank=1000;b.mood='neutral';b.wins=0;b.losses=0;});
  }
  return {getBots:()=>BOTS,getDelay,getLine,updateMood,updateBank,resetBots};
})();

/* ‚îÄ‚îÄ MODULE: DICE PHYSICS ENGINE ‚îÄ‚îÄ */
const DicePhysics = (() => {
  // Standard Western die: opposite faces sum to 7 (1‚Üî6, 2‚Üî5, 3‚Üî4)
  // Rotation to bring face N to viewer's front:
  const FACE_ROTS={1:{x:0,y:0},2:{x:90,y:0},3:{x:0,y:90},4:{x:0,y:-90},5:{x:-90,y:0},6:{x:0,y:180}};
  let activeIntervals=[];
  function roll(die3dEls,results,onComplete,speedMult){
    activeIntervals.forEach(id=>clearInterval(id));
    activeIntervals=[];
    const spinDur=Math.floor(500/speedMult), tickMs=35, maxTicks=Math.floor(spinDur/tickMs);
    let done=0;
    die3dEls.forEach((el,i)=>{
      el.classList.add('rolling'); el.style.transition='none'; let tick=0;
      const id=setInterval(()=>{
        tick++;
        el.style.transform=`rotateX(${RNG.range(0,360)}deg) rotateY(${RNG.range(0,360)}deg) rotateZ(${RNG.range(-20,20)}deg)`;
        if(tick>=maxTicks){
          clearInterval(id); el.classList.remove('rolling');
          const t=FACE_ROTS[results[i]];
          const sdur=Math.floor(220/speedMult);
          el.style.transition=`transform ${sdur}ms cubic-bezier(0.215,0.61,0.355,1)`;
          el.style.transform=`rotateX(${t.x+RNG.range(2,5)*360}deg) rotateY(${t.y+RNG.range(2,5)*360}deg) rotateZ(0deg)`;
          done++; if(done===die3dEls.length) setTimeout(onComplete,sdur+Math.floor(80/speedMult));
        }
      },tickMs);
      activeIntervals.push(id);
    });
  }
  return {roll};
})();

/* ‚îÄ‚îÄ MODULE: UI BUILDER ‚îÄ‚îÄ */
const UIBuilder = (() => {
  const PIP_POS={
    1:[[1,1]],2:[[0,2],[2,0]],3:[[0,2],[1,1],[2,0]],
    4:[[0,0],[0,2],[2,0],[2,2]],5:[[0,0],[0,2],[1,1],[2,0],[2,2]],
    6:[[0,0],[1,0],[2,0],[0,2],[1,2],[2,2]]
  };
  const FACE_DEFS=[{cls:'f-front',num:1},{cls:'f-back',num:6},{cls:'f-top',num:2},{cls:'f-bottom',num:5},{cls:'f-right',num:4},{cls:'f-left',num:3}];

  function buildPipGrid(n){
    const pos=PIP_POS[n]||[]; const g=document.createElement('div'); g.className='pip-grid';
    for(let r=0;r<3;r++) for(let c=0;c<3;c++){
      const cell=document.createElement('div'); cell.className='pip-cell';
      if(pos.some(([pr,pc])=>pr===r&&pc===c)){const p=document.createElement('div');p.className='pip';cell.appendChild(p);}
      g.appendChild(cell);
    }
    return g;
  }
  function createDie(id){
    const wrap=document.createElement('div'); wrap.className='die-wrap'; wrap.id=`die-wrap-${id}`;
    const die=document.createElement('div'); die.className='die-3d'; die.id=`die3d-${id}`;
    FACE_DEFS.forEach(({cls,num})=>{const f=document.createElement('div');f.className=`d-face ${cls}`;f.appendChild(buildPipGrid(num));die.appendChild(f);});
    wrap.appendChild(die); return {wrap,die};
  }

  function buildBotCard(bot,showResult){
    const card=document.createElement('div'); card.className='bot-card inactive'; card.id=`bot-card-${bot.id}`;
    card.innerHTML=`
      <div class="bot-card-hdr">
        <div class="bot-name">${bot.name}</div>
        <div class="bot-mood mood-${bot.mood}" id="bot-mood-${bot.id}"></div>
      </div>
      <div class="bot-meters">
        <div class="meter-row"><div class="meter-lbl">Conf</div><div class="meter-track"><div class="conf-bar" id="bot-conf-${bot.id}" style="width:${bot.conf*100}%"></div></div></div>
        <div class="meter-row"><div class="meter-lbl">Tilt</div><div class="meter-track"><div class="tilt-bar" id="bot-tilt-${bot.id}" style="width:${bot.tilt*100}%"></div></div></div>
      </div>
      <div class="bot-footer">
        <div class="bot-bank" id="bot-bank-${bot.id}">$${bot.bank}</div>
        <div class="bot-say" id="bot-say-${bot.id}"></div>
      </div>
      ${showResult?`<div class="bot-result-bubble" id="bot-rbubble-${bot.id}"></div>`:''}
    `;
    return card;
  }

  function buildProbPanel(mode){
    const body=document.getElementById('prob-body'); body.innerHTML='';
    document.getElementById('prob-mode-lbl').textContent=mode==='ceelo'||mode==='botceelo'?'CEE-LO':'STREET';
    if(mode!=='ceelo'&&mode!=='botceelo'){
      body.innerHTML=`
        <div class="prob-sect"><div class="p-label">Phase</div><div class="p-val" id="pp-phase" style="font-size:20px">Come-Out</div><div class="p-sub" id="pp-sub">Win: 22.2% ¬∑ Loss: 11.1% ¬∑ Point: 66.7%</div></div>
        <div class="prob-sect"><div class="p-label">Current Point</div><div class="p-val" id="pp-point">‚Äî</div><div class="p-sub" id="pp-odds">‚Äî</div>
          <div class="dual-track"><div class="dual-a" id="pp-bar-a" style="width:50%"></div><div class="dual-b"></div></div>
          <div class="dual-labels"><span>Point</span><span>Seven</span></div>
        </div>
        <div class="prob-sect"><div class="p-label">Expected Rolls to Resolve</div><div class="p-val" id="pp-exp" style="font-size:20px">‚Äî</div><div class="p-sub">average per resolution</div></div>
        <div class="prob-sect"><div class="p-label">2d6 Distribution</div>
          <div class="mini-dist" id="pp-dist">${[2,3,4,5,6,7,8,9,10,11,12].map(n=>`<div class="dist-bar ${n===7?'seven-bar':''}" id="dist-${n}" style="height:${[1,2,3,4,5,6,5,4,3,2,1][[2,3,4,5,6,7,8,9,10,11,12].indexOf(n)]/6*100}%" title="${n}"></div>`).join('')}</div>
          <div style="display:flex;justify-content:space-between;margin-top:4px;font-size:8px;color:var(--text3)"><span>2</span><span>7</span><span>12</span></div>
        </div>
        <div class="prob-sect"><div class="p-label">Roll History</div><div class="roll-chips" id="pp-chips"><div style="font-size:9px;color:var(--text3)">No rolls yet</div></div></div>
        <div class="prob-sect"><div class="p-label">Expected Value</div>
          <div class="ev-row"><span class="ev-name">Pass Line EV</span><span class="ev-val">-1.41%</span></div>
          <div class="ev-row"><span class="ev-name">Per $100</span><span class="ev-val">-$1.41</span></div>
        </div>`;
    }else{
      body.innerHTML=`
        <div class="prob-sect"><div class="p-label">Last Result</div><div class="p-val" id="pp-ceelo-type" style="font-size:14px;line-height:1.3">‚Äî</div><div class="p-sub" id="pp-ceelo-sub">Roll to begin</div></div>
        <div class="prob-sect"><div class="p-label">Strength</div><div class="p-val" id="pp-ceelo-score">‚Äî</div><div class="p-sub" id="pp-ceelo-rank">Rank: ‚Äî</div><div class="str-track"><div class="str-fill" id="pp-str" style="width:0%"></div></div></div>
        <div class="prob-sect"><div class="p-label">Combos That Beat This</div><div class="p-val" id="pp-stronger" style="font-size:20px">‚Äî</div><div class="p-sub" id="pp-stronger-sub">of 216 total</div></div>
        <div class="prob-sect"><div class="p-label">Reroll Probability</div><div class="p-val" style="font-size:20px">55.6%</div><div class="p-sub">120/216 combos force reroll</div></div>
        <div class="prob-sect"><div class="p-label">Auto-Win (4-5-6)</div><div class="p-val" style="font-size:20px">0.46%</div><div class="p-sub">1 in 216 ‚Äî true rarity</div></div>
        <div class="prob-sect"><div class="p-label">Roll History</div><div class="roll-chips" id="pp-chips"><div style="font-size:9px;color:var(--text3)">No rolls yet</div></div></div>`;
    }
  }
  return {createDie,buildBotCard,buildProbPanel};
})();

/* ‚îÄ‚îÄ MODULE: ALLEY RENDERER ‚îÄ‚îÄ */
const AlleyRenderer = (() => {
  let raf=null, t=0, flick=0;
  function draw(canvas){
    if(!canvas.offsetWidth)return;
    canvas.width=canvas.offsetWidth; canvas.height=canvas.offsetHeight;
    const ctx=canvas.getContext('2d'), W=canvas.width, H=canvas.height;
    ctx.clearRect(0,0,W,H);
    const sky=ctx.createLinearGradient(0,0,0,H);
    sky.addColorStop(0,'#060507');sky.addColorStop(0.5,'#0a0809');sky.addColorStop(1,'#0d0c09');
    ctx.fillStyle=sky;ctx.fillRect(0,0,W,H);
    const wW=Math.min(220,W*0.18);
    ctx.fillStyle='rgba(12,9,7,0.7)';ctx.fillRect(0,0,wW,H);ctx.fillRect(W-wW,0,wW,H);
    _bricks(ctx,0,0,wW,H);_bricks(ctx,W-wW,0,wW,H);
    const pY=H*0.55, pave=ctx.createLinearGradient(0,pY,0,H);
    pave.addColorStop(0,'#090807');pave.addColorStop(0.5,'#0c0b08');pave.addColorStop(1,'#0e0d0a');
    ctx.fillStyle=pave;ctx.fillRect(0,pY,W,H-pY);
    const fv=0.12+Math.sin(flick)*0.03+Math.sin(flick*2.7)*0.01;
    const cone=ctx.createRadialGradient(W/2,0,0,W/2,0,H*1.1);
    cone.addColorStop(0,`rgba(255,220,160,${fv})`);cone.addColorStop(0.45,`rgba(200,155,80,${fv*0.25})`);cone.addColorStop(1,'transparent');
    ctx.beginPath();ctx.moveTo(W/2,-10);ctx.lineTo(W/2-H*0.6,H);ctx.lineTo(W/2+H*0.6,H);ctx.closePath();ctx.fillStyle=cone;ctx.fill();
    ctx.save();ctx.strokeStyle='rgba(255,255,255,0.04)';ctx.lineWidth=1.5;ctx.setLineDash([5,10]);
    ctx.beginPath();ctx.ellipse(W/2,H*0.58,180,45,0,0,Math.PI*2);ctx.stroke();ctx.restore();
    flick+=0.025;t+=0.01;
  }
  function _bricks(ctx,x,y,w,h){const bh=20,bw=38;ctx.fillStyle='rgba(25,18,10,0.35)';for(let r=0;r<h/bh;r++){const off=(r%2)*(bw/2);for(let c=-1;c<w/bw+1;c++)ctx.fillRect(x+c*bw+off+1,y+r*bh+1,bw-2,bh-2);}}
  function start(canvas){function loop(){draw(canvas);raf=requestAnimationFrame(loop);}loop();}
  function stop(){if(raf)cancelAnimationFrame(raf);}
  return {start,stop};
})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   EXPANSION 1: LIVE SCOREBOARD MODULE
   Tracks all players (you + bots), auto-ranks by bankroll.
   Updates after every resolved round.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const Scoreboard = (() => {
  // Player entry: {id, name, wins, losses, bank}
  let entries=[];

  function init(playerBank, bots){
    entries=[{id:'player',name:'‚≠ê You',wins:0,losses:0,bank:playerBank}];
    bots.forEach(b=>entries.push({id:`bot${b.id}`,name:b.name,wins:b.wins,losses:b.losses,bank:b.bank}));
    render();
  }

  function update(id, outcome, bank){
    const e=entries.find(x=>x.id===id);
    if(!e)return;
    if(outcome==='win') e.wins++;
    if(outcome==='loss') e.losses++;
    if(bank!==undefined) e.bank=bank;
    render();
  }

  function render(){
    const sorted=[...entries].sort((a,b)=>b.bank-a.bank);
    const container=document.getElementById('scoreboard-rows');
    if(!container)return;
    container.innerHTML='';
    sorted.forEach((e,idx)=>{
      const row=document.createElement('div');
      row.className='scoreboard-row'+(idx===0?' sb-leader':'');
      const rankCls=idx===0?'sb-rank gold':'sb-rank';
      row.innerHTML=`
        <div class="${rankCls}">${idx+1}</div>
        <div class="sb-name" title="${e.name}">${e.name}</div>
        <div class="sb-wins">${e.wins}W</div>
        <div class="sb-losses">${e.losses}L</div>
        <div class="sb-bank">$${e.bank}</div>
      `;
      container.appendChild(row);
    });
  }

  function syncBotBanks(bots){
    bots.forEach(b=>{
      const e=entries.find(x=>x.id===`bot${b.id}`);
      if(e){e.bank=b.bank;e.wins=b.wins;e.losses=b.losses;}
    });
    render();
  }

  return {init,update,syncBotBanks,render};
})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   EXPANSION 2: CINEMATIC TENSION ENGINE
   Reads current street-dice point phase probability.
   Drives visual tension state: none ‚Üí warning ‚Üí danger ‚Üí extreme.
   Also triggers slow-roll cinematic on near-critical points.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const TensionEngine = (() => {
  let currentTension=0; // 0=none, 1=warning, 2=danger, 3=extreme
  let flashTimer=null;

  function update(phase, point, mode){
    // Tension only active in street dice point phase
    if((mode!=='street'&&mode!=='bot')||phase!=='point'||!point){
      _setTension(0);
      return 0;
    }
    const sp=Prob.streetPoint(point);
    // pWin = conditional prob of hitting point vs seven
    // 4: pWin=0.4, 10: pWin=0.4, 5: pWin=0.45, 9: pWin=0.45, 6: pWin=0.455, 8: pWin=0.455
    const pWin=sp.pWin;
    let level=0;
    if(pWin<0.5)  level=1; // warning
    if(pWin<0.44) level=2; // danger
    if(pWin<0.41) level=3; // extreme (4, 10)
    _setTension(level);
    return level;
  }

  function _setTension(level){
    if(level===currentTension) return;
    currentTension=level;
    const ov=document.getElementById('tension-overlay');
    const stage=document.getElementById('dice-stage');
    const dice=document.querySelectorAll('.die-3d');
    if(!ov) return;
    ov.className='tension-overlay';
    if(stage) stage.classList.remove('slow-tension');
    dice.forEach(d=>d.classList.remove('tense'));
    if(level===1){ov.classList.add('danger');}
    else if(level===2){ov.classList.add('danger');dice.forEach(d=>d.classList.add('tense'));}
    else if(level===3){ov.classList.add('extreme');if(stage)stage.classList.add('slow-tension');dice.forEach(d=>d.classList.add('tense'));}
  }

  function flash(){
    // Brief red flash on roll in high-tension state
    if(currentTension<2) return;
    const fl=document.getElementById('slowroll-flash');
    if(!fl) return;
    if(flashTimer) clearTimeout(flashTimer);
    fl.classList.add('flash');
    flashTimer=setTimeout(()=>fl.classList.remove('flash'),150);
  }

  function clear(){_setTension(0);}
  function getLevel(){return currentTension;}
  return {update,flash,clear,getLevel};
})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   EXPANSION 3: CEE-LO BOT TABLE SHOWDOWN ENGINE
   
   Each round:
   1. Player rolls ‚Üí may reroll until valid result
   2. All 4 bots roll in sequence ‚Üí each may reroll until valid
   3. Showdown: compare all 5 results by ceeloRank()
   4. Winner(s) announced, ties handled, bankrolls updated
   5. Round count shown, scoreboard updates
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const ShowdownEngine = (() => {
  let roundResults = {}; // {playerId: ceelo_result}
  let roundNum = 1;
  let roundActive = false;

  function startRound(){
    roundResults={};
    roundActive=true;
    _updateRoundBadge();
  }

  function recordResult(id, result){
    roundResults[id]=result;
  }

  function allResultsIn(playerIds){
    return playerIds.every(id=>roundResults[id]);
  }

  function resolveRound(playerIds, playerBankroll, bots){
    if(!roundActive) return null;
    roundActive=false;
    roundNum++;

    // Find winner(s)
    let maxRank=-1;
    playerIds.forEach(id=>{
      const r=roundResults[id];
      if(r){const rank=Prob.ceeloRank(r);if(rank>maxRank)maxRank=rank;}
    });

    const winners=playerIds.filter(id=>roundResults[id]&&Prob.ceeloRank(roundResults[id])===maxRank);
    const isDraw=winners.length>1;

    // Update banks
    const pot=100; // stake per player
    playerIds.forEach(id=>{
      if(winners.includes(id)&&!isDraw){
        // winner gets pot from each loser ‚Äî simplified: +100 per non-winner
        const losers=playerIds.filter(x=>!winners.includes(x));
        if(id==='player') return; // handled via bankroll in main controller
      }
    });

    return {winners,isDraw,maxRank,results:roundResults,roundNum:roundNum-1};
  }

  function showShowdownBanner(resolution, playerName, bots, playerBankroll){
    const banner=document.getElementById('showdown-banner');
    const resultsDiv=document.getElementById('showdown-results');
    const winText=document.getElementById('showdown-winner-text');
    const winSub=document.getElementById('showdown-winner-sub');
    if(!banner) return;

    const allIds=['player',...bots.map(b=>`bot${b.id}`)];
    const names={'player':playerName};
    bots.forEach(b=>{names[`bot${b.id}`]=b.name;});

    resultsDiv.innerHTML='';
    allIds.forEach((id,idx)=>{
      const res=resolution.results[id];
      if(!res) return;
      const isWinner=resolution.winners.includes(id);
      const rank=Prob.ceeloRank(res);
      const entry=document.createElement('div');
      entry.className='showdown-entry'+(isWinner?' winner':resolution.isDraw?' draw':' loser');
      entry.style.animation=`showdownEntry 0.3s ease ${idx*0.08}s both`;
      const rollLabel=res.type==='autowin'?'4¬∑5¬∑6':res.type==='autoloss'?'1¬∑2¬∑3':res.type==='triple'?`${res.triples}√ó3`:res.score!==null?String(res.score):'‚Äî';
      const typeLabel=res.type==='autowin'?'AUTO WIN':res.type==='autoloss'?'AUTO LOSS':res.type==='triple'?`TRIPS ${res.triples}s`:res.type==='point'?`POINT ${res.score}`:'‚Äî';
      entry.innerHTML=`<div class="se-name">${names[id]||id}</div><div class="se-roll">${rollLabel}</div><div class="se-type">${typeLabel}</div>`;
      resultsDiv.appendChild(entry);
    });

    if(resolution.isDraw){
      winText.textContent='DRAW';
      winText.style.color='#a0a0f0';
      winSub.textContent='All winners split the pot';
    } else {
      const wId=resolution.winners[0];
      winText.textContent=`${names[wId]||wId} WINS`;
      winText.style.color=wId==='player'?'var(--gold2)':'var(--text)';
      winSub.textContent=`Round ${resolution.roundNum} complete`;
    }

    banner.classList.add('show');
    setTimeout(()=>banner.classList.remove('show'), 3200);
  }

  function _updateRoundBadge(){
    const b=document.getElementById('round-badge');
    if(b){b.textContent=`ROUND ${roundNum}`;b.classList.add('show');}
  }

  function getRound(){return roundNum;}
  function reset(){roundNum=1;roundResults={};roundActive=false;_updateRoundBadge();}
  return {startRound,recordResult,allResultsIn,resolveRound,showShowdownBanner,getRound,reset};
})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MAIN GAME CONTROLLER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const G = (() => {
  let mode='street', phase='comeout', point=null;
  let rolling=false, autoPlay=false, autoTimer=null;
  let bankroll=1000, sessionStart=0, sessionTimer=null, cooldownTimer=null;
  let die3dEls=[], currentRoller='player', botTurnQueue=[];
  let currentScreen='home', prevLevel=1;
  let objective=null, objProgress=0;
  let alleyStarted=false;

  // Reroll state
  let rerollActive=false, rerollCount=0;

  // Bot Cee-Lo Showdown state
  let showdownQueue=[];       // ids still needing to roll this round
  let showdownPending=false;  // waiting for all bots to finish before reveal

  function init(){
    _buildBotList();
    _buildDiceStage(2);
    UIBuilder.buildProbPanel('street');
    _buildStatsGrid();
    _updateHomeXP();
    objective=ObjectiveEngine.pick();
    _updateObjectiveUI();
  }

  function showScreen(id){
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    document.getElementById(`scr-${id}`).classList.add('active');
    currentScreen=id;
    if(id==='game'){if(!alleyStarted){AlleyRenderer.start(document.getElementById('alley-bg'));alleyStarted=true;}_resizeArena();}
    if(id==='reality')_buildRealityScreen();
    if(id==='stats')  _buildStatsGrid();
    if(id==='home')   _updateHomeXP();
  }

  function selectMode(m){
    mode=m;
    ['street','ceelo','bot','botceelo'].forEach(n=>{
      document.getElementById(`mc-${n}`).classList.toggle('selected',n===m);
    });
  }

  function enterGame(){
    phase='comeout'; point=null; rolling=false;
    rerollActive=false; rerollCount=0;
    showdownQueue=[]; showdownPending=false;
    bankroll=1000; Stats.reset();
    sessionStart=Date.now();

    const isCeelo=mode==='ceelo'||mode==='botceelo';
    _buildDiceStage(isCeelo?3:2);
    UIBuilder.buildProbPanel(isCeelo?'ceelo':'street');

    const badgeText={street:'STREET DICE',ceelo:'CEE-LO',bot:'BOT TABLE',botceelo:'CEE-LO TABLE'}[mode]||mode.toUpperCase();
    document.getElementById('hud-mode').textContent=badgeText;
    document.getElementById('bot-panel-mode-badge').textContent=isCeelo?'CEE-LO':'STREET';

    _buildBotList();
    _updateBankroll();
    _setTurnUI('player');
    _setRerollUI(false,0);
    TensionEngine.clear();

    // Scoreboard init
    Scoreboard.init(bankroll, BotAI.getBots());
    if(mode==='botceelo'){
      ShowdownEngine.reset();
      document.getElementById('round-badge').classList.add('show');
      ShowdownEngine.startRound();
    } else {
      document.getElementById('round-badge').classList.remove('show');
    }

    showScreen('game');
    _startSessionTimer();
    document.getElementById('stim-fill').style.width='100%';
    document.documentElement.style.setProperty('--sat','1');
    document.documentElement.style.setProperty('--bri','1');
    objective=ObjectiveEngine.pick(); objProgress=0;
    _updateObjectiveUI();
  }

  function _buildDiceStage(count){
    const stage=document.getElementById('dice-stage'); stage.innerHTML=''; die3dEls=[];
    for(let i=0;i<count;i++){const{wrap,die}=UIBuilder.createDie(i);stage.appendChild(wrap);die3dEls.push(die);}
  }

  function _buildBotList(){
    const list=document.getElementById('bot-list'); list.innerHTML='';
    const showResult=mode==='botceelo';
    // Add player card first in botceelo mode
    if(mode==='botceelo'){
      const pCard=document.createElement('div'); pCard.className='bot-card inactive'; pCard.id='bot-card-player';
      pCard.innerHTML=`
        <div class="bot-card-hdr"><div class="bot-name">‚≠ê You</div><div class="bot-mood mood-hot" id="bot-mood-player"></div></div>
        <div class="bot-footer"><div class="bot-bank" id="bot-bank-player">$${bankroll}</div><div class="bot-say" id="bot-say-player"></div></div>
        <div class="bot-result-bubble" id="bot-rbubble-player"></div>`;
      list.appendChild(pCard);
    }
    BotAI.getBots().forEach(bot=>list.appendChild(UIBuilder.buildBotCard(bot,showResult)));
  }

  function _startSessionTimer(){
    if(sessionTimer)clearInterval(sessionTimer);
    sessionTimer=setInterval(_tickSession,1000);
  }

  function _tickSession(){
    const elapsed=Date.now()-sessionStart;
    const secs=Math.floor(elapsed/1000), m=Math.floor(secs/60), s=secs%60;
    document.getElementById('timer-text').textContent=`${m}:${String(s).padStart(2,'0')}`;
    document.getElementById('timer-ring').style.strokeDashoffset=113*(1-Math.min(elapsed/(30*60*1000),1));
    const decay=DecayEngine.update(elapsed);
    document.getElementById('stim-fill').style.width=(decay.stim*100)+'%';
    if(DecayEngine.isExpired()&&currentScreen==='game'){clearInterval(sessionTimer);_triggerCooldown();}
  }

  function _triggerCooldown(){
    if(rolling)return;
    document.getElementById('roll-btn').disabled=true;
    showScreen('cooldown');
    let rem=5*60;
    if(cooldownTimer)clearInterval(cooldownTimer);
    cooldownTimer=setInterval(()=>{
      rem--;
      document.getElementById('cd-timer').textContent=`${String(Math.floor(rem/60)).padStart(2,'0')}:${String(rem%60).padStart(2,'0')}`;
      if(rem<=0){clearInterval(cooldownTimer);showScreen('home');document.getElementById('roll-btn').disabled=false;}
    },1000);
  }

  /* ‚ïê‚ïê ROLL ENTRY POINT ‚ïê‚ïê */
  function roll(){
    if(rolling||currentRoller!=='player')return;
    if(mode==='ceelo'||mode==='botceelo') _doCeeloRoll('player');
    else _doStreetRoll('player');
  }

  function _sm(){return parseFloat(document.getElementById('speed-sel').value)||1;}

  /* ‚ïê‚ïê STREET DICE ‚ïê‚ïê */
  function _doStreetRoll(roller){
    rolling=true;
    if(roller==='player')document.getElementById('roll-btn').disabled=true;
    TensionEngine.flash();
    const d1=RNG.d6(),d2=RNG.d6();
    document.getElementById('dice-stage').classList.add('fading');
    DicePhysics.roll(die3dEls,[d1,d2],()=>{
      document.getElementById('dice-stage').classList.remove('fading');
      _handleStreetResult(StreetResolver.resolve(d1,d2,phase,point),roller);
    },_sm());
  }

  function _handleStreetResult(res,roller){
    const isPlayer=roller==='player';
    Stats.record({...res,roller});
    _addChip(res);

    let xpGain=10,bannerType='reroll',botEvent='reroll';
    if(res.outcome==='win'){
      xpGain=res.type==='natural'?20:35; bannerType='win'; botEvent='win';
      if(isPlayer)bankroll+=100;
      phase='comeout';point=null;_updatePointDisplay();
      TensionEngine.clear();
      document.getElementById('seven-vig')?document.getElementById('seven-vig').classList.remove('danger'):null;
    }else if(res.outcome==='loss'){
      xpGain=5;bannerType='loss';botEvent='loss';
      if(isPlayer)bankroll-=100;
      phase='comeout';point=null;_updatePointDisplay();
      TensionEngine.clear();
    }else if(res.outcome==='point'){
      xpGain=15;bannerType='point';botEvent='point';
      phase='point';point=res.sum;_updatePointDisplay();
    }else{xpGain=8;}

    // Update tension AFTER phase changes
    const tensionLevel=TensionEngine.update(phase,point,mode);
    document.getElementById('slowroll-lbl').classList.toggle('show',tensionLevel>=2&&phase==='point');

    const banner=res.outcome==='win'?(res.type==='natural'?'NATURAL WIN':`POINT ${point||res.sum} ‚Äî HIT`):
                 res.outcome==='loss'?(res.type==='seven_out'?'SEVEN OUT':'CRAPS'):
                 res.outcome==='point'?`POINT: ${res.sum}`:`${res.sum} ‚Äî ROLL AGAIN`;

    _showResolution(banner,bannerType);
    if(!isPlayer)_botSpeak(roller,botEvent);
    _grantXP(xpGain);
    _updateBankroll();
    _updateProbPanel();
    _checkObjective(res);
    Scoreboard.update(roller,res.outcome,isPlayer?bankroll:undefined);
    Scoreboard.syncBotBanks(BotAI.getBots());

    setTimeout(()=>{_hideResolution();rolling=false;_nextTurn(roller);},Math.floor(1200/_sm()));
  }

  /* ‚ïê‚ïê CEE-LO ROLL (Solo + BotCeelo) ‚ïê‚ïê */
  function _doCeeloRoll(roller){
    rolling=true;
    if(roller==='player')document.getElementById('roll-btn').disabled=true;
    const d1=RNG.d6(),d2=RNG.d6(),d3=RNG.d6();
    document.getElementById('dice-stage').classList.add('fading');
    DicePhysics.roll(die3dEls,[d1,d2,d3],()=>{
      document.getElementById('dice-stage').classList.remove('fading');
      _handleCeeloResult(CeeloResolver.resolve(d1,d2,d3),roller);
    },_sm());
  }

  function _handleCeeloResult(res,roller){
    const isPlayer=roller==='player';
    Stats.record({...res,roller});

    /* ‚îÄ‚îÄ REROLL: Same player rolls again ‚îÄ‚îÄ */
    if(res.outcome==='reroll'){
      rerollActive=true; rerollCount++;
      Stats.get().rerolls++; Stats.get().sessionRerolls++;
      _grantXP(5);
      _setRerollUI(true,rerollCount);
      _showResolution(res.label,'reroll');
      _addChip(res);
      _updateCeeloPanel(res,Prob.ceeloStrength(res));

      // Show reroll bubble on bot card
      if(!isPlayer){
        const bubbleId=`bot-rbubble-${roller.replace('bot','')}`;
        _showBotBubble(bubbleId,'‚Ü©','brb-reroll');
        const card=document.getElementById(`bot-card-${roller.replace('bot','')}`);
        if(card)card.classList.add('rerolling-bot');
      } else {
        _showBotBubble('bot-rbubble-player','‚Ü©','brb-reroll');
      }
      if(!isPlayer)_botSpeak(roller,'reroll');

      setTimeout(()=>{
        _hideResolution(); rolling=false;
        if(isPlayer){
          document.getElementById('roll-btn').disabled=false;
          document.getElementById('roll-btn').classList.add('rerolling');
          _showToast(`‚Ü© Roll again ‚Äî no valid combo (reroll #${rerollCount})`);
        } else {
          const botIdx=parseInt(roller.replace('bot',''));
          const bot=BotAI.getBots()[botIdx];
          setTimeout(()=>_doCeeloRoll(roller),BotAI.getDelay(bot,_sm()));
        }
      },Math.floor(800/_sm()));
      return;
    }

    /* ‚îÄ‚îÄ VALID RESULT ‚îÄ‚îÄ */
    rerollActive=false; rerollCount=0;
    _setRerollUI(false,0);
    document.getElementById('roll-btn').classList.remove('rerolling');
    // Clear bot card rerolling state
    document.querySelectorAll('.bot-card.rerolling-bot').forEach(c=>c.classList.remove('rerolling-bot'));

    let bannerType='point',xpGain=10,botEvent='point';
    if(res.outcome==='autowin'){bannerType='autowin';xpGain=50;botEvent='win';if(isPlayer)bankroll+=200;}
    else if(res.outcome==='autoloss'){bannerType='autoloss';xpGain=5;botEvent='loss';if(isPlayer)bankroll-=100;}
    else if(res.outcome==='win'){bannerType='triple';xpGain=35;botEvent='win';if(isPlayer)bankroll+=100;}
    else if(res.outcome==='point'){bannerType='point';xpGain=12;}

    // Show result bubble on bot card
    const bubbleClass=res.outcome==='autowin'||res.outcome==='win'?'brb-win':res.outcome==='autoloss'?'brb-loss':'brb-point';
    const bubbleLabel=res.type==='autowin'?'456':res.type==='autoloss'?'123':res.type==='triple'?`${res.triples}x3`:String(res.score);
    if(!isPlayer){
      _showBotBubble(`bot-rbubble-${roller.replace('bot','')}`,bubbleLabel,bubbleClass);
    } else {
      _showBotBubble('bot-rbubble-player',bubbleLabel,bubbleClass);
    }

    _showResolution(res.label,bannerType);
    _updateCeeloPanel(res,Prob.ceeloStrength(res));
    _addChip(res);
    _grantXP(xpGain);

    if(!isPlayer)_botSpeak(roller,botEvent);
    _checkObjective(res);

    // ‚îÄ‚îÄ If in botceelo showdown mode, record and check if round complete ‚îÄ‚îÄ
    if(mode==='botceelo'){
      ShowdownEngine.recordResult(roller,res);
      const allIds=['player',...BotAI.getBots().map(b=>`bot${b.id}`)];
      if(ShowdownEngine.allResultsIn(allIds)){
        // All players have valid results ‚Äî trigger showdown
        const resolution=ShowdownEngine.resolveRound(allIds, bankroll, BotAI.getBots());
        // Update banks based on round winner
        _applyShowdownBanks(resolution, allIds);
        setTimeout(()=>{
          _hideResolution();
          ShowdownEngine.showShowdownBanner(resolution,'‚≠ê You',BotAI.getBots(),bankroll);
          _updateBankroll();
          Scoreboard.update('player',resolution.winners.includes('player')?'win':'loss',bankroll);
          Scoreboard.syncBotBanks(BotAI.getBots());
          rolling=false;
          // Start next round after showdown display
          setTimeout(()=>{
            ShowdownEngine.startRound();
            _setAllBotsInactive();
            _setTurnUI('player');
            document.getElementById('roll-btn').disabled=false;
            currentRoller='player';
            if(autoPlay)_scheduleAutoRoll();
          },3500);
        },Math.floor(1200/_sm()));
        return;
      }
      // More players still need to roll ‚Äî continue turn queue
      _updateBankroll();
      setTimeout(()=>{_hideResolution();rolling=false;_nextCeeloShowdownTurn(roller);},Math.floor(1200/_sm()));
      return;
    }

    _updateBankroll();
    setTimeout(()=>{_hideResolution();rolling=false;_nextTurn(roller);},Math.floor(1400/_sm()));
  }

  function _applyShowdownBanks(resolution, allIds){
    const stake=100;
    const losers=allIds.filter(id=>!resolution.winners.includes(id));
    if(resolution.isDraw) return; // no money moves on draw
    resolution.winners.forEach(wId=>{
      const gain=stake*losers.length/resolution.winners.length;
      if(wId==='player') bankroll+=Math.floor(gain);
      else {
        const bot=BotAI.getBots()[parseInt(wId.replace('bot',''))];
        if(bot) bot.bank+=Math.floor(gain);
      }
    });
    losers.forEach(lId=>{
      if(lId==='player') bankroll=Math.max(0,bankroll-stake);
      else {
        const bot=BotAI.getBots()[parseInt(lId.replace('bot',''))];
        if(bot) bot.bank=Math.max(0,bot.bank-stake);
      }
    });
  }

  /* ‚îÄ‚îÄ Bot Cee-Lo Showdown turn queue ‚îÄ‚îÄ */
  function _nextCeeloShowdownTurn(lastRoller){
    // In botceelo: player goes first, then all bots in sequence
    if(lastRoller==='player'){
      showdownQueue=[0,1,2,3];
      _runNextShowdownBot();
    } else {
      const idx=parseInt(lastRoller.replace('bot',''));
      if(idx<3){
        showdownQueue=[idx+1,2,3].filter(i=>i>idx);
        _runNextShowdownBot();
      } else {
        // Shouldn't happen ‚Äî allResultsIn should have caught this
        _setAllBotsInactive();
        _setTurnUI('player');
        currentRoller='player';
        document.getElementById('roll-btn').disabled=false;
      }
    }
  }

  function _runNextShowdownBot(){
    if(!showdownQueue.length) return;
    const idx=showdownQueue.shift();
    const bot=BotAI.getBots()[idx];
    _setAllBotsInactive();
    const card=document.getElementById(`bot-card-${idx}`);
    if(card){card.classList.add('active-roller');card.classList.remove('inactive');}
    _setTurnUI(`bot${idx}`);
    currentRoller=`bot${idx}`;
    setTimeout(()=>_doCeeloRoll(`bot${idx}`), BotAI.getDelay(bot,_sm()));
  }

  /* ‚îÄ‚îÄ TURN MANAGEMENT (Street / Solo Cee-Lo) ‚îÄ‚îÄ */
  function _nextTurn(currentRollerArg){
    if(currentRollerArg==='player'){
      if(mode==='bot'){
        const q=[0,1,2,3];
        _runBotTurn(q[0],q.slice(1));
      } else {
        _setTurnUI('player');currentRoller='player';
        document.getElementById('roll-btn').disabled=false;
        if(autoPlay)_scheduleAutoRoll();
      }
    } else {
      const idx=parseInt(currentRollerArg.replace('bot',''));
      if(idx<3&&mode==='bot') _runBotTurn(idx+1,[idx+2,idx+3].filter(i=>i<=3));
      else {
        _setAllBotsInactive();_setTurnUI('player');currentRoller='player';
        document.getElementById('roll-btn').disabled=false;
        if(autoPlay)_scheduleAutoRoll();
      }
    }
  }

  function _runBotTurn(idx,remaining){
    const bot=BotAI.getBots()[idx];
    _setAllBotsInactive();
    const card=document.getElementById(`bot-card-${idx}`);
    if(card){card.classList.add('active-roller');card.classList.remove('inactive');}
    _setTurnUI(`bot${idx}`); currentRoller=`bot${idx}`;
    setTimeout(()=>{
      if(mode==='ceelo'||mode==='botceelo') _doCeeloRoll(`bot${idx}`);
      else _doStreetRoll(`bot${idx}`);
    }, BotAI.getDelay(bot,_sm()));
  }

  function _setAllBotsInactive(){
    for(let i=0;i<4;i++){const c=document.getElementById(`bot-card-${i}`);if(c){c.classList.remove('active-roller','rerolling-bot');c.classList.add('inactive');}}
  }

  function _botSpeak(roller,event){
    const idx=parseInt(roller.replace('bot',''));
    const bots=BotAI.getBots();
    if(idx<0||idx>3)return;
    const bot=bots[idx]; const line=BotAI.getLine(bot,event); if(!line)return;
    const el=document.getElementById(`bot-say-${idx}`);
    if(el){el.textContent=`"${line}"`;el.style.opacity='1';setTimeout(()=>{el.style.opacity='0.4';},2500);}
    BotAI.updateMood(bot,event==='win'?'win':event==='loss'?'loss':null);
    BotAI.updateBank(bot,event);
    _syncBotCard(bot);
    Scoreboard.syncBotBanks(bots);
  }

  function _syncBotCard(bot){
    const conf=document.getElementById(`bot-conf-${bot.id}`);
    const tilt=document.getElementById(`bot-tilt-${bot.id}`);
    const bank=document.getElementById(`bot-bank-${bot.id}`);
    const mood=document.getElementById(`bot-mood-${bot.id}`);
    if(conf)conf.style.width=`${bot.conf*100}%`;
    if(tilt)tilt.style.width=`${bot.tilt*100}%`;
    if(bank)bank.textContent=`$${bot.bank}`;
    if(mood){mood.className='bot-mood';mood.classList.add(`mood-${bot.mood}`);}
  }

  function _showBotBubble(bubbleId, text, cls){
    const b=document.getElementById(bubbleId);
    if(!b)return;
    b.textContent=text; b.className=`bot-result-bubble show ${cls} brb-reroll-anim`;
    setTimeout(()=>{if(b)b.className=`bot-result-bubble show ${cls}`;},800);
  }

  /* ‚îÄ‚îÄ PROBABILITY PANEL ‚îÄ‚îÄ */
  function _updateProbPanel(){
    if(mode==='ceelo'||mode==='botceelo')return;
    const phEl=document.getElementById('pp-phase'); if(!phEl)return;
    if(phase==='comeout'){
      const co=Prob.streetComeOut();
      phEl.textContent='Come-Out';
      document.getElementById('pp-sub').textContent=`Win: ${(co.pWin*100).toFixed(1)}%  ¬∑  Loss: ${(co.pLoss*100).toFixed(1)}%  ¬∑  Point: ${(co.pPoint*100).toFixed(1)}%`;
      document.getElementById('pp-point').textContent='‚Äî';
      document.getElementById('pp-odds').textContent='‚Äî';
      document.getElementById('pp-exp').textContent='‚Äî';
      document.getElementById('pp-bar-a').style.width='50%';
    }else if(point){
      const sp=Prob.streetPoint(point);
      phEl.textContent='Point Phase';
      document.getElementById('pp-sub').textContent=`Each roll: ${(sp.pResolve*100).toFixed(1)}% resolve chance`;
      document.getElementById('pp-point').textContent=point;
      document.getElementById('pp-odds').textContent=`Hit ${point}: ${(sp.pWin*100).toFixed(1)}%  vs  Seven: ${((1-sp.pWin)*100).toFixed(1)}%`;
      document.getElementById('pp-exp').textContent=sp.expectedRolls.toFixed(1)+' rolls';
      document.getElementById('pp-bar-a').style.width=`${sp.pWin*100}%`;
    }
    _updateDistBars();
  }

  function _updateDistBars(){
    const s=Stats.get(), total=s.totalRolls||1;
    [2,3,4,5,6,7,8,9,10,11,12].forEach(n=>{
      const el=document.getElementById(`dist-${n}`); if(!el)return;
      const h=Math.max(5,(s.dist[n]||0)/total/Prob.prob2d6(n)*100*0.4+5);
      el.style.height=`${Math.min(h,100)}%`;
      el.classList.toggle('active-sum',n===point||(!point&&(n===7||n===11)));
    });
  }

  function _updateCeeloPanel(res,strength){
    const typeEl=document.getElementById('pp-ceelo-type'); if(!typeEl)return;
    typeEl.textContent=res.label;
    const sub=res.type==='reroll'?'No valid combo ‚Äî must reroll':
              res.type==='autowin'?'4-5-6 ‚Äî Highest possible roll':
              res.type==='autoloss'?'1-2-3 ‚Äî Automatic loss':
              res.type==='triple'?`Three ${res.triples}s ‚Äî Beats all points`:
              res.type==='point'?`Score: ${res.score} (odd die, not the sum)`:'‚Äî';
    document.getElementById('pp-ceelo-sub').textContent=sub;
    const scoreText=res.type==='autowin'?'AUTO WIN':res.type==='autoloss'?'AUTO LOSS':res.type==='triple'?`${res.triples}-${res.triples}-${res.triples}`:res.type==='point'?String(res.score):res.type==='reroll'?'REROLL':'‚Äî';
    document.getElementById('pp-ceelo-score').textContent=scoreText;
    document.getElementById('pp-ceelo-rank').textContent=`Rank: ${strength.rank}/14 ‚Äî Beats ${strength.pct}% of combos`;
    document.getElementById('pp-str').style.width=`${strength.pct}%`;
    document.getElementById('pp-stronger').textContent=strength.stronger;
    document.getElementById('pp-stronger-sub').textContent='combos beat this roll (of 216)';
  }

  function _showResolution(text,type){const b=document.getElementById('res-banner');b.className=`res-banner show res-${type}`;b.textContent=text;}
  function _hideResolution(){const b=document.getElementById('res-banner');b.classList.remove('show');setTimeout(()=>{b.className='res-banner';},400);}
  function _updateBankroll(){
    document.getElementById('hud-bank').textContent=`$${bankroll.toLocaleString()}`;
    Stats.setBank(bankroll);
    // Update player card bank in botceelo mode
    const pb=document.getElementById('bot-bank-player'); if(pb)pb.textContent=`$${bankroll}`;
  }
  function _updatePointDisplay(){
    const el=document.getElementById('point-display');
    if(point){el.textContent=`POINT: ${point}`;el.className='point-display has-point';}
    else{el.textContent='';el.className='point-display';}
  }
  function _setTurnUI(roller){
    const pill=document.getElementById('turn-pill');
    if(roller==='player'){
      pill.textContent=rerollActive?'‚Ü© REROLL ‚Äî YOUR TURN':'‚ñ∂ YOUR TURN';
      pill.className='turn-pill player-turn'+(rerollActive?' reroll-turn':'');
    }else{
      const idx=parseInt(roller.replace('bot',''));
      const name=BotAI.getBots()[idx]?.name||`Bot ${idx+1}`;
      pill.textContent=rerollActive?`‚Ü© ${name} RE-ROLLING`:`‚ñ∂ ${name}`;
      pill.className='turn-pill'+(rerollActive?' reroll-turn':'');
    }
  }
  function _setRerollUI(active,count){
    const ind=document.getElementById('reroll-indicator');
    const cnt=document.getElementById('reroll-count');
    if(active){ind.classList.add('show');cnt.textContent=count;}else{ind.classList.remove('show');}
  }
  function _grantXP(n){
    const ld=Stats.addXP(n);
    if(ld.level>prevLevel){prevLevel=ld.level;_showLevelUp(ld.level);}
    document.getElementById('hud-level').textContent=`LVL ${ld.level}`;
    document.getElementById('hud-xp-fill').style.width=`${ld.pct}%`;
  }
  function _updateHomeXP(){
    const ld=XP.calcLevel(Stats.get().totalXP);
    document.getElementById('home-level-lbl').textContent=`Level ${ld.level}`;
    document.getElementById('home-xp-lbl').textContent=`${Stats.get().totalXP} / ${Stats.get().totalXP+ld.needed} XP`;
    document.getElementById('home-xp-fill').style.width=`${ld.pct}%`;
  }
  function _showLevelUp(lvl){
    document.getElementById('lvl-toast-text').textContent=`Level ${lvl}`;
    const t=document.getElementById('lvl-toast'); t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000);
  }
  function _addChip(res){
    const c=document.getElementById('pp-chips'); if(!c)return;
    const fc=c.firstChild;
    if(fc&&fc.nodeType===1&&fc.style&&fc.style.fontSize==='9px')c.innerHTML='';
    const chip=document.createElement('div');
    let cls='r-chip-reroll';
    if(res.outcome==='win'||res.outcome==='autowin')cls='r-chip-win';
    else if(res.outcome==='loss'||res.outcome==='autoloss')cls='r-chip-loss';
    else if(res.outcome==='point')cls='r-chip-point';
    chip.className=`r-chip ${cls}`;
    chip.textContent=res.sum!==undefined?res.sum:res.type==='autowin'?'456':res.type==='autoloss'?'123':res.type==='triple'?`${res.triples}√ó3`:res.type==='reroll'?'‚Ü©':res.score!==null?res.score:'‚Äî';
    chip.title=res.outcome+(res.type?` (${res.type})`:'');
    c.appendChild(chip);
    if(c.children.length>24)c.removeChild(c.firstChild);
    const streak=Stats.get().currentStreak, badge=document.getElementById('streak-badge');
    if(streak>=3){badge.textContent=`üî• ${streak} STREAK`;badge.classList.add('show');}else badge.classList.remove('show');
  }
  function _updateObjectiveUI(){
    if(!objective)return;
    document.getElementById('obj-text').textContent=objective.text;
    document.getElementById('obj-prog').textContent=`${objProgress}/${objective.target}`;
    document.getElementById('hud-obj').innerHTML=`OBJ: <span>${objective.text}</span>`;
    document.getElementById('obj-tracker').classList.remove('hide');
  }
  function _checkObjective(res){
    if(!objective)return;
    const s=Stats.get(); let progress=objProgress;
    if(objective.stat==='sessionRolls')progress=s.sessionRolls;
    else if(objective.stat==='currentStreak')progress=s.currentStreak;
    else if(objective.stat==='pointsSurvived'&&res.type==='point_hit')progress=++objProgress;
    else if(objective.stat==='ceeloAutowins'&&res.type==='autowin')progress=++objProgress;
    else if(objective.stat==='rollsWithoutSeven')progress=s.rollsWithoutSeven;
    else if(objective.stat==='sessionRerolls')progress=s.sessionRerolls;
    objProgress=progress;
    document.getElementById('obj-prog').textContent=`${Math.min(objProgress,objective.target)}/${objective.target}`;
    if(objProgress>=objective.target){
      _grantXP(objective.xp);_showToast(`üéØ Objective complete! +${objective.xp} XP`);
      document.getElementById('obj-dot').classList.add('complete');
      setTimeout(()=>{objective=ObjectiveEngine.pick();objProgress=0;document.getElementById('obj-dot').classList.remove('complete');document.getElementById('obj-dot').classList.add('active-obj');_updateObjectiveUI();},2500);
    }
  }
  function _buildRealityScreen(){
    const s=Stats.get(), total=s.totalRolls||1;
    document.getElementById('r-total-big').textContent=s.totalRolls;
    const dp=document.getElementById('r-dist-pane');
    dp.innerHTML='<div class="r-pane-title">2d6 Distribution (Street Dice)</div>';
    const exp={2:2.78,3:5.56,4:8.33,5:11.11,6:13.89,7:16.67,8:13.89,9:11.11,10:8.33,11:5.56,12:2.78};
    [2,3,4,5,6,7,8,9,10,11,12].forEach(n=>{
      const act=((s.dist[n]||0)/total*100).toFixed(1), diff=parseFloat(act)-exp[n];
      const hc=Math.abs(diff)<1?'heat-match':diff>0?'heat-over':'heat-under';
      dp.innerHTML+=`<div class="heat-row"><div class="heat-lbl"><span>${n}</span><span>${act}% <span style="color:var(--text3)">(exp ${exp[n]}%)</span></span></div><div class="heat-track"><div class="heat-fill ${hc}" style="width:${Math.min((s.dist[n]||0)/total*600,100)}%"></div></div></div>`;
    });
    const mp=document.getElementById('r-metrics-pane'), wl=s.wins+s.losses||1, pnl=s.bankroll-s.startBankroll;
    mp.innerHTML=`<div class="r-pane-title">Performance Metrics</div>
      <div class="r-row"><span class="r-name">Total Rolls</span><span class="r-actual">${s.totalRolls}</span></div>
      <div class="r-row"><span class="r-name">Seven Frequency</span><span class="r-actual">${(s.sevenCount/total*100).toFixed(1)}%<span class="r-expected"> (exp 16.7%)</span></span></div>
      <div class="r-row"><span class="r-name">Win Rate</span><span class="r-actual">${(s.wins/wl*100).toFixed(1)}%</span></div>
      <div class="r-row"><span class="r-name">Longest Streak</span><span class="r-actual">${s.longestStreak}</span></div>
      <div class="r-row"><span class="r-name">Reroll Rate</span><span class="r-actual">${(s.rerolls/total*100).toFixed(1)}%</span></div>
      <div class="r-row"><span class="r-name">Net P&L</span><span class="r-actual" style="color:${pnl>=0?'var(--green)':'var(--red2)'}">${pnl>=0?'+':''}$${pnl}</span></div>
      <div class="r-row"><span class="r-name">Pass Line EV/roll</span><span class="r-actual">-$1.41 / $100</span></div>
      <div class="r-row"><span class="r-name">Sessions Played</span><span class="r-actual">${s.sessions}</span></div>`;
  }
  function _buildStatsGrid(){
    const s=Stats.get(), total=s.totalRolls||1;
    const data=[
      {lbl:'Total Rolls',    val:s.totalRolls,  sub:'lifetime'},
      {lbl:'Seven Rate',     val:(s.sevenCount/total*100).toFixed(1)+'%', sub:'expected 16.7%'},
      {lbl:'Win / Loss',     val:`${s.wins}/${s.losses}`, sub:'resolved games'},
      {lbl:'Longest Streak', val:s.longestStreak, sub:'consecutive wins'},
      {lbl:'Current Level',  val:`LVL ${XP.calcLevel(s.totalXP).level}`, sub:`${s.totalXP} total XP`},
      {lbl:'Sessions',       val:s.sessions, sub:'simulated instead of real'},
    ];
    document.getElementById('stats-grid').innerHTML=data.map(d=>`<div class="s-card"><div class="s-card-lbl">${d.lbl}</div><div class="s-card-val">${d.val}</div><div class="s-card-sub">${d.sub}</div></div>`).join('');
  }
  function toggleAuto(){
    autoPlay=!autoPlay;
    const btn=document.getElementById('btn-auto');
    btn.classList.toggle('toggled',autoPlay); btn.textContent=autoPlay?'Auto ‚óè':'Auto Play';
    if(autoPlay&&!rolling&&currentRoller==='player'&&!rerollActive)_scheduleAutoRoll();
  }
  function _scheduleAutoRoll(){
    if(autoTimer)clearTimeout(autoTimer);
    autoTimer=setTimeout(()=>{if(!rolling&&currentRoller==='player'&&autoPlay)roll();},Math.floor(900/_sm()));
  }
  function selectMood(el){document.querySelectorAll('.mood-btn').forEach(b=>b.classList.remove('sel'));el.classList.add('sel');}
  function submitUrge(){_showToast('Entry logged. Playing here was the right call.');}
  function resetSession(){
    if(sessionTimer)clearInterval(sessionTimer);
    rerollActive=false;rerollCount=0;
    document.getElementById('roll-btn').classList.remove('rerolling');
    _setRerollUI(false,0); TensionEngine.clear();
    BotAI.resetBots();
    enterGame();
  }
  function _resizeArena(){const c=document.getElementById('arena-canvas');if(c.parentElement){c.width=c.parentElement.offsetWidth;c.height=c.parentElement.offsetHeight;}}
  function _showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2800);}
  window.addEventListener('resize',()=>{if(currentScreen==='game')_resizeArena();});
  return {init,showScreen,selectMode,enterGame,roll,toggleAuto,selectMood,submitUrge,resetSession};
})();

document.addEventListener('DOMContentLoaded',()=>G.init());
</script>
</body>
</html>